<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Weimar Crisis — Expansion Roles</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=UnifrakturCook:wght@700&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Secret Hitler Color Palette */
            --fascist-red: #C23B22;
            --fascist-dark: #8B2500;
            --fascist-light: #E8654A;
            --liberal-blue: #4A6FA5;
            --liberal-dark: #2C4A6E;
            --liberal-light: #6B8FC5;
            --cream: #D4C5A9;
            --cream-light: #E8DFD0;
            --tan: #B8A888;
            --brown: #2C2416;
            --brown-light: #5A4A32;
            --gold: #C9A227;
            --bg-red: #E8654A;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--bg-red);
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 20px,
                    rgba(0,0,0,0.03) 20px,
                    rgba(0,0,0,0.03) 40px
                );
            color: var(--brown);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ============================================
           TYPOGRAPHY
           ============================================ */
        .title-english {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .title-german {
            font-family: 'UnifrakturCook', cursive;
            font-weight: 700;
        }

        /* ============================================
           SCREENS
           ============================================ */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .screen.active {
            display: flex;
        }

        /* ============================================
           START SCREEN
           ============================================ */
        #start-screen {
            text-align: center;
        }

        .logo-container {
            margin-bottom: 40px;
        }

        .logo-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: var(--brown);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--cream);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .logo-icon svg {
            width: 70px;
            height: 70px;
            fill: var(--cream);
        }

        .logo-title {
            font-size: 3rem;
            color: var(--cream);
            text-shadow: 3px 3px 0 var(--brown), 4px 4px 0 rgba(0,0,0,0.2);
            margin-bottom: 8px;
        }

        .logo-fraktur {
            font-family: 'UnifrakturCook', cursive;
            font-size: 2.6rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .logo-subtitle {
            font-family: 'UnifrakturCook', cursive;
            font-size: 1.6rem;
            color: var(--cream);
            opacity: 0.7;
            margin-top: 4px;
        }

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 320px;
        }

        .btn {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 0.1em;
            padding: 16px 32px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: var(--brown);
            color: var(--cream);
            border: 3px solid var(--cream);
            box-shadow: 0 4px 0 var(--fascist-dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 var(--fascist-dark);
        }

        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--fascist-dark);
        }

        .btn-secondary {
            background: var(--cream);
            color: var(--brown);
            border: 3px solid var(--brown);
            box-shadow: 0 4px 0 var(--tan);
        }

        .btn-inspect {
            background: transparent;
            color: var(--cream);
            border: 2px solid var(--cream);
            font-size: 0.9rem;
            padding: 10px 20px;
            opacity: 0.7;
            margin-top: 16px;
        }

        .btn-inspect:hover {
            opacity: 1;
            background: rgba(212, 197, 169, 0.1);
        }

        /* ============================================
           INSPECT ROLES SCREEN
           ============================================ */
        #inspect-screen,
        #lobby-screen {
            overflow-y: auto;
            justify-content: flex-start;
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .inspect-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .inspect-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--cream);
            text-align: center;
            margin-bottom: 24px;
            letter-spacing: 0.1em;
        }

        .inspect-role-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inspect-role-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--cream);
            border: 3px solid var(--brown);
            color: var(--brown);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .inspect-role-btn:hover {
            background: var(--brown);
            color: var(--cream);
            transform: translateY(-2px);
        }

        .inspect-role-btn:active {
            transform: translateY(0);
        }

        .inspect-role-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .join-input-group {
            display: flex;
            gap: 8px;
        }

        .join-input {
            flex: 1;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.15em;
            padding: 16px;
            border: 3px solid var(--brown);
            background: var(--cream);
            color: var(--brown);
            text-align: center;
            text-transform: uppercase;
        }

        .join-input::placeholder {
            color: var(--tan);
            opacity: 1;
        }

        .btn-join {
            padding: 16px 24px;
            font-size: 1.2rem;
        }

        /* ============================================
           NAME INPUT SCREEN
           ============================================ */
        .name-container {
            background: var(--cream);
            border: 4px solid var(--brown);
            padding: 32px;
            max-width: 360px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .name-container::before,
        .name-container::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid var(--brown);
        }

        .name-container::before {
            top: 8px;
            left: 8px;
            border-right: none;
            border-bottom: none;
        }

        .name-container::after {
            bottom: 8px;
            right: 8px;
            border-left: none;
            border-top: none;
        }

        .name-label {
            font-size: 1.5rem;
            color: var(--brown);
            margin-bottom: 16px;
        }

        .name-input {
            width: 100%;
            font-family: 'Crimson Pro', serif;
            font-size: 1.3rem;
            padding: 14px;
            border: 3px solid var(--brown);
            background: white;
            color: var(--brown);
            text-align: center;
            margin-bottom: 20px;
        }

        /* ============================================
           LOBBY SCREEN
           ============================================ */
        .lobby-container {
            background: var(--cream);
            border: 4px solid var(--brown);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .lobby-container::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--brown);
            padding: 4px 20px;
            color: var(--cream);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 0.2em;
        }

        .lobby-code {
            background: var(--brown);
            color: var(--cream);
            padding: 12px 24px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .lobby-code-label {
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            opacity: 0.7;
        }

        .lobby-code-value {
            font-size: 2rem;
            letter-spacing: 0.2em;
        }

        .lobby-players {
            margin: 20px 0;
            text-align: left;
        }

        .lobby-players-title {
            font-size: 1rem;
            color: var(--brown);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--tan);
        }

        .player-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--tan);
        }

        .player-number {
            width: 28px;
            height: 28px;
            background: var(--brown);
            color: var(--cream);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
        }

        .player-name {
            flex: 1;
            font-size: 1.1rem;
        }

        .player-host {
            font-size: 0.7rem;
            background: var(--gold);
            color: var(--brown);
            padding: 2px 8px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
        }

        .lobby-status {
            font-size: 0.9rem;
            color: var(--brown-light);
            margin: 16px 0;
            font-style: italic;
        }

        .lobby-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        /* ============================================
           ROLE CONFIGURATION
           ============================================ */
        .role-config {
            background: rgba(44, 36, 22, 0.1);
            border: 1px solid var(--brown-light);
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
        }

        .role-config-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
            color: var(--brown);
        }

        .role-config-mode {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .role-mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--brown);
        }

        .role-mode-option input[type="radio"] {
            accent-color: var(--red);
        }

        .role-mode-option select {
            padding: 4px 8px;
            font-size: 0.9rem;
            border: 1px solid var(--brown-light);
            background: var(--cream);
            color: var(--brown);
            font-family: inherit;
        }

        .role-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--brown-light);
        }

        .role-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--cream);
            border: 1px solid var(--brown-light);
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .role-checkbox:has(input:checked) {
            background: var(--brown);
            color: var(--cream);
            border-color: var(--brown);
        }

        .role-checkbox input {
            display: none;
        }

        .role-config-info {
            font-size: 0.8rem;
            color: var(--brown-light);
            margin-top: 12px;
            font-style: italic;
        }

        .role-hint {
            font-size: 0.75rem;
            font-weight: normal;
            opacity: 0.7;
            font-family: 'Crimson Pro', serif;
        }

        .view-roles-link {
            text-align: center;
            margin-bottom: 16px;
        }

        .view-roles-link a {
            color: var(--cream);
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .view-roles-link a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .view-roles-link i {
            margin-right: 4px;
        }

        /* ============================================
           WAITING SCREEN
           ============================================ */
        .waiting-container {
            text-align: center;
            color: var(--cream);
        }

        .waiting-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--cream);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .waiting-text {
            font-size: 1.5rem;
            text-shadow: 2px 2px 0 var(--brown);
        }

        .waiting-subtext {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 8px;
        }

        /* ============================================
           REVEAL SCREEN
           ============================================ */
        .reveal-container {
            text-align: center;
        }

        .reveal-card {
            width: 280px;
            height: 400px;
            background: var(--brown);
            border: 4px solid var(--cream);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        .reveal-card:hover {
            transform: scale(1.02);
        }

        .reveal-card:active {
            transform: scale(0.98);
        }

        .reveal-card-inner {
            text-align: center;
            color: var(--cream);
        }

        .reveal-question {
            font-size: 8rem;
            font-family: 'Bebas Neue', sans-serif;
            line-height: 1;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .reveal-text {
            font-size: 1.2rem;
            margin-top: 16px;
            letter-spacing: 0.1em;
        }

        .reveal-german {
            font-size: 1rem;
            margin-top: 8px;
            opacity: 0.7;
        }

        /* Decorative corners on reveal card */
        .reveal-card::before,
        .reveal-card::after,
        .reveal-card .corner-bl,
        .reveal-card .corner-br {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid var(--cream);
        }

        .reveal-card::before {
            top: 12px;
            left: 12px;
            border-right: none;
            border-bottom: none;
        }

        .reveal-card::after {
            top: 12px;
            right: 12px;
            border-left: none;
            border-bottom: none;
        }

        .reveal-card .corner-bl {
            bottom: 12px;
            left: 12px;
            border-right: none;
            border-top: none;
        }

        .reveal-card .corner-br {
            bottom: 12px;
            right: 12px;
            border-left: none;
            border-top: none;
        }

        /* ============================================
           ROLE CARD DISPLAY
           ============================================ */
        .role-card-container {
            perspective: 1000px;
        }

        .role-card {
            width: 300px;
            min-height: 380px;
            background: var(--cream);
            border: 3px solid var(--brown);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        .role-card-inner {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Header section */
        .role-header {
            background: var(--tan);
            padding: 16px 12px;
            text-align: center;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--brown);
        }

        .role-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: var(--brown);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .role-icon svg {
            width: 40px;
            height: 40px;
            fill: var(--cream);
        }

        .role-title {
            font-size: 1.6rem;
            color: var(--brown);
            line-height: 1.1;
        }

        .role-subtitle {
            font-size: 1.3rem;
            color: var(--brown-light);
            margin-top: 4px;
        }

        /* Power section */
        .role-power {
            flex: 1;
            padding: 0 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .power-name-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .power-name {
            font-size: 1.4rem;
            font-family: 'Bebas Neue', sans-serif;
            color: var(--brown);
            letter-spacing: 0.05em;
        }

        .once-badge {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            background: var(--red);
            color: white;
            padding: 2px 6px;
            border-radius: 2px;
        }

        .power-desc {
            font-size: 1rem;
            color: var(--brown);
            text-align: center;
            line-height: 1.5;
        }

        .power-note {
            font-size: 0.85rem;
            color: var(--brown-light);
            text-align: center;
            margin-top: 12px;
            font-style: italic;
        }

        /* Quote footer */
        .role-quote {
            margin-top: auto;
            padding: 12px;
            background: var(--brown);
            color: var(--cream);
            text-align: center;
            position: relative;
        }

        .quote-text {
            font-size: 0.8rem;
            font-style: italic;
            line-height: 1.35;
        }

        .quote-attr {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* ============================================
           REFERENCE CARD
           ============================================ */
        .ref-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px solid var(--tan);
        }

        .ref-icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            background: var(--brown);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ref-icon svg {
            width: 18px;
            height: 18px;
            fill: var(--cream);
        }

        .ref-text {
            font-size: 0.85rem;
            color: var(--brown);
        }

        .ref-text strong {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
        }

        /* ============================================
           BACK BUTTON
           ============================================ */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: var(--brown);
            border: 3px solid var(--cream);
            color: var(--cream);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .back-btn:hover {
            background: var(--brown-light);
        }

        /* ============================================
           STATUS MESSAGES
           ============================================ */
        .status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--brown);
            color: var(--cream);
            padding: 12px 24px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            z-index: 200;
        }

        .status-message.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .status-message.error {
            background: var(--fascist-red);
        }

        /* ============================================
           PRINT MODE (for reference cards)
           ============================================ */
        @media print {
            body {
                background: white;
                padding: 8px;
            }
            .screen { display: block !important; }
            #start-screen, #name-screen, #lobby-screen, 
            #waiting-screen, #reveal-screen { display: none !important; }
            .back-btn { display: none; }
        }

        /* ============================================
           MOBILE OPTIMIZATIONS
           ============================================ */
        @media (max-width: 360px) {
            .role-card {
                width: 280px;
                height: 400px;
            }
            .role-title { font-size: 1.4rem; }
            .role-subtitle { font-size: 1.1rem; }
            .power-desc { font-size: 0.85rem; }
        }

        /* ============================================
           NO ROLE CARD (when not assigned)
           ============================================ */
        .no-role-card {
            width: 300px;
            height: 440px;
            background: var(--cream);
            border: 4px solid var(--brown);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 32px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        .no-role-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .no-role-text {
            font-size: 1.3rem;
            color: var(--brown);
            margin-bottom: 8px;
        }

        .no-role-german {
            font-size: 1.1rem;
            color: var(--brown-light);
        }

        .no-role-subtext {
            font-size: 0.9rem;
            color: var(--brown-light);
            margin-top: 16px;
            font-style: italic;
        }

        /* Behavior Card */
        .behavior-card {
            border-color: var(--blue);
        }

        .behavior-power {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 24px 16px;
        }

        .behavior-desc {
            font-size: 1.15rem;
            line-height: 1.6;
            color: var(--brown);
        }

        .behavior-reminder {
            margin-top: 24px;
            font-size: 0.85rem;
            color: var(--brown-light);
            font-style: italic;
        }

        /* Inspect Section Title */
        .inspect-section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            color: var(--cream);
            letter-spacing: 0.1em;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        /* Role Navigation Tabs */
        .role-screen-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .role-nav-tabs {
            display: flex;
            gap: 8px;
        }

        .role-nav-tab {
            padding: 10px 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 0.05em;
            background: var(--cream);
            color: var(--brown);
            border: 2px solid var(--brown);
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .role-nav-tab.active {
            opacity: 1;
            background: var(--brown);
            color: var(--cream);
        }

        .role-nav-tab:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

    <!-- ==================== START SCREEN ==================== -->
    <div id="start-screen" class="screen active">
        <div class="logo-container">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 4l5 2.18V11H7V7.18L12 5z"/>
                </svg>
            </div>
            <h1 class="logo-title title-english">WEIMAR CRISIS</h1>
            <h2 class="logo-subtitle title-german">Kriſe in Weimar</h2>
        </div>
        <div class="start-buttons">
            <button class="btn btn-primary" onclick="showScreen('name-screen', true)">Create New Game</button>
            <div class="join-input-group">
                <input type="text" class="join-input" id="join-code-input" placeholder="GAME CODE" maxlength="10">
                <button class="btn btn-secondary btn-join" onclick="joinWithCode()">Join</button>
            </div>
            <button class="btn btn-inspect" onclick="showScreen('inspect-screen')">Inspect Roles</button>
        </div>
    </div>

    <!-- ==================== INSPECT ROLES SCREEN ==================== -->
    <div id="inspect-screen" class="screen">
        <button class="back-btn" onclick="showScreen('start-screen')">←</button>
        <div class="inspect-container">
            <h2 class="inspect-title title-english">Inspect Roles</h2>
            <div class="inspect-role-list" id="inspect-role-list">
                <!-- Role buttons will be generated here -->
            </div>
        </div>
    </div>

    <!-- ==================== INSPECT ROLE DISPLAY SCREEN ==================== -->
    <div id="inspect-role-screen" class="screen">
        <button class="back-btn" onclick="showScreen('inspect-screen')">←</button>
        <div class="role-card-container" id="inspect-role-card-container">
            <!-- Role card will be inserted here -->
        </div>
    </div>

    <!-- ==================== NAME INPUT SCREEN ==================== -->
    <div id="name-screen" class="screen">
        <button class="back-btn" onclick="showScreen('start-screen')">←</button>
        <div class="name-container">
            <h2 class="name-label title-english">Enter Your Name</h2>
            <input type="text" class="name-input" id="player-name-input" placeholder="Your Name" maxlength="20">
            <button class="btn btn-primary" onclick="confirmName()" style="width: 100%;">Continue</button>
        </div>
    </div>

    <!-- ==================== LOBBY SCREEN ==================== -->
    <div id="lobby-screen" class="screen">
        <button class="back-btn" onclick="leaveLobby()">←</button>
        <div class="lobby-container">
            <div class="lobby-code">
                <div class="lobby-code-label title-english">Game Code</div>
                <div class="lobby-code-value title-english" id="lobby-code-display">XXXX00</div>
            </div>
            
            <div class="lobby-players">
                <div class="lobby-players-title title-english">
                    Players (<span id="player-count">0</span>)
                </div>
                <ul class="player-list" id="player-list">
                    <!-- Players will be added dynamically -->
                </ul>
            </div>

            <!-- View Roles Link -->
            <div class="view-roles-link" id="view-roles-link" style="display: none;">
                <a href="#" onclick="showScreen('inspect-screen'); return false;">
                    <i class="fas fa-info-circle"></i> View all role descriptions
                </a>
            </div>

            <!-- Power Role Configuration (Host Only) -->
            <div class="role-config" id="role-config" style="display: none;">
                <div class="role-config-title title-english">Power Roles <span class="role-hint">(special one-time abilities)</span></div>
                <div class="role-config-mode">
                    <label class="role-mode-option">
                        <input type="radio" name="roleMode" value="random" checked onchange="updateRoleMode()">
                        <span>All roles (random)</span>
                    </label>
                    <label class="role-mode-option">
                        <input type="radio" name="roleMode" value="count" onchange="updateRoleMode()">
                        <span>Number of roles:</span>
                        <select id="role-count-select" onchange="updateRoleCount()" disabled>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6" selected>6</option>
                        </select>
                    </label>
                    <label class="role-mode-option">
                        <input type="radio" name="roleMode" value="specific" onchange="updateRoleMode()">
                        <span>Choose specific:</span>
                    </label>
                </div>
                <div class="role-checkboxes" id="role-checkboxes" style="display: none;">
                    <!-- Role checkboxes will be generated -->
                </div>
                <div class="role-config-info" id="role-config-info">
                    Extra players will receive "No Power Role"
                </div>
            </div>

            <!-- Behavior Role Configuration (Host Only) -->
            <div class="role-config" id="behavior-config" style="display: none;">
                <div class="role-config-title title-english">Behavior Roles <span class="role-hint">(how you should act)</span></div>
                <div class="role-config-mode">
                    <label class="role-mode-option">
                        <input type="radio" name="behaviorMode" value="random" checked onchange="updateBehaviorMode()">
                        <span>Random selection</span>
                    </label>
                    <label class="role-mode-option">
                        <input type="radio" name="behaviorMode" value="count" onchange="updateBehaviorMode()">
                        <span>Number of behaviors:</span>
                        <select id="behavior-count-select" onchange="updateBehaviorCount()" disabled>
                            <option value="0">0 (none)</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="19" selected>All (19)</option>
                        </select>
                    </label>
                    <label class="role-mode-option">
                        <input type="radio" name="behaviorMode" value="specific" onchange="updateBehaviorMode()">
                        <span>Choose specific:</span>
                    </label>
                </div>
                <div class="role-checkboxes" id="behavior-checkboxes" style="display: none;">
                    <!-- Behavior checkboxes will be generated -->
                </div>
                <div class="role-config-info" id="behavior-config-info">
                    Each player also gets a random behavior role
                </div>
            </div>

            <div class="lobby-status" id="lobby-status">Waiting for players...</div>

            <div class="lobby-actions">
                <button class="btn btn-primary" id="deal-roles-btn" onclick="dealRoles()" style="display: none;">
                    Deal Expansion Roles
                </button>
                <button class="btn btn-secondary" onclick="copyGameCode()">Copy Game Code</button>
            </div>
        </div>
    </div>

    <!-- ==================== WAITING SCREEN ==================== -->
    <div id="waiting-screen" class="screen">
        <div class="waiting-container">
            <div class="waiting-spinner"></div>
            <div class="waiting-text title-english" id="waiting-text">Waiting for Host</div>
            <div class="waiting-subtext" id="waiting-subtext">The host will deal roles soon...</div>
        </div>
    </div>

    <!-- ==================== REVEAL SCREEN ==================== -->
    <div id="reveal-screen" class="screen">
        <button class="back-btn" onclick="backToLobby()">←</button>
        <div class="reveal-container">
            <div class="reveal-card" onclick="revealRole()">
                <div class="corner-bl"></div>
                <div class="corner-br"></div>
                <div class="reveal-card-inner">
                    <div class="reveal-question">?</div>
                    <div class="reveal-text title-english">Tap to Reveal</div>
                    <div class="reveal-german title-german">Tippen zum Enthüllen</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== ROLE DISPLAY SCREEN ==================== -->
    <div id="role-screen" class="screen">
        <button class="back-btn" onclick="hideRole()">←</button>
        <div class="role-screen-content">
            <div class="role-nav-tabs" id="role-nav-tabs">
                <button class="role-nav-tab active" id="power-tab" onclick="showPowerRole()">Power</button>
                <button class="role-nav-tab" id="behavior-tab" onclick="showBehaviorRole()">Behavior</button>
            </div>
            <div class="role-card-container" id="role-card-container">
                <!-- Role card will be inserted here -->
            </div>
        </div>
    </div>

    <!-- ==================== STATUS MESSAGE ==================== -->
    <div class="status-message" id="status-message"></div>

    <!-- ==================== ROLE DATA ==================== -->
    <script>
        const ROLES = {
            'police_chief': {
                title: 'Police Chief',
                subtitle: 'Polizeipräſident',
                powerName: 'Arrest',
                powerDesc: 'Once per game, during any discussion, arrest one player. They cannot serve as President or Chancellor until pardoned by a sitting President.',
                powerNote: 'Arrested players may still vote and speak.',
                icon: `<i class="fas fa-handcuffs"></i>`
            },
            'assassin': {
                title: 'The Assassin',
                subtitle: 'Der Attentäter',
                powerName: 'Assassinate',
                powerDesc: 'Once per game, during any discussion, eliminate one player from the game permanently.',
                powerNote: 'Cannot use while arrested. Killing Hitler = Liberal victory.',
                icon: `<i class="fas fa-crosshairs"></i>`
            },
            'journalist': {
                title: 'The Journalist',
                subtitle: 'Der Reporter',
                powerName: 'Exposé',
                powerDesc: 'Once per game, after a legislative session, force the President or Chancellor to truthfully reveal one policy they discarded.',
                powerNote: null,
                icon: `<i class="fas fa-newspaper"></i>`
            },
            'industrialist': {
                title: 'The Industrialist',
                subtitle: 'Der Großinduſtrielle',
                powerName: 'Fund',
                powerDesc: 'Once per game, during voting, fund the proposed government. The election passes automatically regardless of votes.',
                powerNote: null,
                icon: `<i class="fas fa-landmark"></i>`
            },
            'union_organizer': {
                title: 'Union Organizer',
                subtitle: 'Der Gewerkſchaftsführer',
                powerName: 'General Strike',
                powerDesc: 'Once per game, during voting, call a general strike. The election fails automatically regardless of votes.',
                powerNote: null,
                icon: `<i class="fas fa-fist-raised"></i>`
            },
            'constitutional_judge': {
                title: 'Constitutional Judge',
                subtitle: 'Der Verfaſſungsrichter',
                powerName: 'Judicial Review',
                powerDesc: 'Once per game, block any executive power (Investigation, Special Election, or Execution) as it is used. That power is lost.',
                powerNote: null,
                icon: `<i class="fas fa-gavel"></i>`
            },
            'no_role': {
                title: 'No Expansion Role',
                subtitle: 'Keine Erweiterungsrolle',
                powerName: null,
                powerDesc: 'You have no expansion role this game. Play with your standard Secret Hitler role only.',
                powerNote: null,
                icon: `<i class="fas fa-ban"></i>`
            }
        };

        // ==================== BEHAVIOR ROLES ====================
        const BEHAVIOR_ROLES = {
            'feminist': {
                title: 'The Feminist',
                subtitle: 'Die Feministin',
                behavior: 'You are distrustful of men in positions of power.',
                icon: `<i class="fas fa-venus"></i>`
            },
            'misogynist': {
                title: 'The Misogynist',
                subtitle: 'Der Frauenfeind',
                behavior: 'You are distrustful of women in positions of power.',
                icon: `<i class="fas fa-mars"></i>`
            },
            'aristocrat': {
                title: 'The Aristocrat',
                subtitle: 'Der Ariſtokrat',
                behavior: 'You distrust common workers and prefer refined, educated types.',
                icon: `<i class="fas fa-gem"></i>`
            },
            'proletarian': {
                title: 'The Proletarian',
                subtitle: 'Der Proletarier',
                behavior: 'You distrust the wealthy and elite classes.',
                icon: `<i class="fas fa-hammer"></i>`
            },
            'pacifist': {
                title: 'The Pacifist',
                subtitle: 'Der Paziſist',
                behavior: 'You distrust anyone who speaks of violence or military force.',
                icon: `<i class="fas fa-dove"></i>`
            },
            'militarist': {
                title: 'The Militarist',
                subtitle: 'Der Militariſt',
                behavior: 'You distrust anyone who seems weak, indecisive, or cowardly.',
                icon: `<i class="fas fa-shield-halved"></i>`
            },
            'monarchist': {
                title: 'The Monarchist',
                subtitle: 'Der Monarchiſt',
                behavior: 'You secretly miss the Kaiser and distrust republicans and democrats.',
                icon: `<i class="fas fa-crown"></i>`
            },
            'revolutionary': {
                title: 'The Revolutionary',
                subtitle: 'Der Revolutionär',
                behavior: 'You distrust moderates and anyone who resists radical change.',
                icon: `<i class="fas fa-fire"></i>`
            },
            'prussian': {
                title: 'The Prussian',
                subtitle: 'Der Preuße',
                behavior: 'You value discipline and order. You distrust those who lack it.',
                icon: `<i class="fas fa-chess-rook"></i>`
            },
            'bavarian': {
                title: 'The Bavarian',
                subtitle: 'Der Bayer',
                behavior: 'You distrust centralized Berlin authority and Prussian influence.',
                icon: `<i class="fas fa-beer-mug-empty"></i>`
            },
            'devout': {
                title: 'The Devout',
                subtitle: 'Der Fromme',
                behavior: 'You distrust atheists, secularists, and the morally loose.',
                icon: `<i class="fas fa-cross"></i>`
            },
            'atheist': {
                title: 'The Atheist',
                subtitle: 'Der Atheiſt',
                behavior: 'You distrust the overtly religious and those who invoke God.',
                icon: `<i class="fas fa-atom"></i>`
            },
            'academic': {
                title: 'The Academic',
                subtitle: 'Der Akademiker',
                behavior: 'You distrust the uneducated and those who rely on emotion over reason.',
                icon: `<i class="fas fa-graduation-cap"></i>`
            },
            'worker': {
                title: 'The Worker',
                subtitle: 'Der Arbeiter',
                behavior: 'You distrust intellectuals, academics, and elites who never labored.',
                icon: `<i class="fas fa-wrench"></i>`
            },
            'veteran': {
                title: 'The Veteran',
                subtitle: 'Der Veteran',
                behavior: 'You only truly trust fellow soldiers who served in the war.',
                icon: `<i class="fas fa-medal"></i>`
            },
            'hothead': {
                title: 'The Hothead',
                subtitle: 'Der Hitzkopf',
                behavior: 'You make decisions based on emotion and instinct, not logic.',
                icon: `<i class="fas fa-bolt"></i>`
            },
            'no_behavior': {
                title: 'No Behavior Role',
                subtitle: 'Keine Verhaltensrolle',
                behavior: 'You have no assigned behavior. Play as yourself.',
                icon: `<i class="fas fa-ban"></i>`
            }
        };

        // ==================== APP STATE ====================
        let gameState = {
            gameCode: null,
            playerId: null,
            playerName: null,
            isHost: false,
            players: [],
            myRole: null,
            myBehavior: null,
            rolesDealt: false,
            revealStep: 0  // 0 = not revealed, 1 = power shown, 2 = behavior shown
        };

        // API endpoint - Apps Script Web App URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbxdCh6SQjhUjNOgjRd0o07Vv2bHlj6u4yJsJ0Sy3EjktJ_f1g4GogYTf4ujM7PLCiaT/exec';
        
        // Polling interval (ms)
        const POLL_INTERVAL = 3000;
        let pollTimer = null;

        // ==================== API HELPER ====================
        async function callAPI(action, params = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({ action, ...params })
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // ==================== SCREEN NAVIGATION ====================
        function showScreen(screenId, isCreating = false) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'name-screen') {
                gameState.isHost = isCreating;
                document.getElementById('player-name-input').focus();
            }
            
            if (screenId === 'inspect-screen') {
                populateInspectRoleList();
            }
        }

        // ==================== INSPECT ROLES ====================
        function populateInspectRoleList() {
            const container = document.getElementById('inspect-role-list');
            const powerRoleIds = [...ALL_SPECIAL_ROLES, 'no_role'];
            const behaviorRoleIds = [...ALL_BEHAVIOR_ROLES, 'no_behavior'];
            
            let html = '<div class="inspect-section-title">Power Roles</div>';
            html += powerRoleIds.map(roleId => {
                const role = ROLES[roleId];
                return `
                    <button class="inspect-role-btn" onclick="inspectRole('${roleId}', 'power')">
                        <span class="inspect-role-icon">${role.icon}</span>
                        <span>${role.title}</span>
                    </button>
                `;
            }).join('');
            
            html += '<div class="inspect-section-title" style="margin-top: 20px;">Behavior Roles</div>';
            html += behaviorRoleIds.map(behaviorId => {
                const behavior = BEHAVIOR_ROLES[behaviorId];
                return `
                    <button class="inspect-role-btn" onclick="inspectRole('${behaviorId}', 'behavior')">
                        <span class="inspect-role-icon">${behavior.icon}</span>
                        <span>${behavior.title}</span>
                    </button>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function inspectRole(roleId, type = 'power') {
            if (type === 'behavior') {
                displayBehaviorCard(roleId, 'inspect-role-card-container');
            } else {
                displayRoleCard(roleId, 'inspect-role-card-container');
            }
            showScreen('inspect-role-screen');
        }

        // ==================== GAME ACTIONS ====================
        async function confirmName() {
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) {
                showStatus('Please enter your name', true);
                return;
            }
            
            gameState.playerName = name;
            
            if (gameState.isHost) {
                await createGame();
            } else {
                await joinGame();
            }
        }

        async function createGame() {
            try {
                showStatus('Creating game...');
                
                // Check if API is configured
                // Call API to create game
                const result = await callAPI('createGame', {
                    hostName: gameState.playerName
                });
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to create game');
                }
                
                gameState.gameCode = result.gameCode;
                gameState.playerId = result.playerId;
                gameState.isHost = true;
                gameState.players = [{
                    id: gameState.playerId,
                    name: gameState.playerName,
                    isHost: true
                }];
                
                saveGameState();
                updateLobbyDisplay();
                showScreen('lobby-screen');
                showStatus('Game created!');
                startPolling();
                
            } catch (error) {
                showStatus('Failed to create game: ' + error.message, true);
                console.error(error);
            }
        }

        function joinWithCode() {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            if (!code) {
                showStatus('Please enter a game code', true);
                return;
            }
            gameState.gameCode = code;
            gameState.isHost = false;
            showScreen('name-screen');
        }

        async function joinGame() {
            try {
                showStatus('Joining game...');
                
                // Call API to join game
                const result = await callAPI('joinGame', {
                    gameCode: gameState.gameCode,
                    playerName: gameState.playerName
                });
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to join game');
                }
                
                gameState.playerId = result.playerId;
                gameState.isHost = false;
                
                saveGameState();
                showScreen('waiting-screen');
                startPolling();
                
            } catch (error) {
                showStatus('Failed to join: ' + error.message, true);
                console.error(error);
            }
        }

        async function dealRoles() {
            if (!gameState.isHost) return;
            
            try {
                showStatus('Dealing roles...');
                
                // First update role config on server (both power and behavior)
                await callAPI('updateRoleConfig', {
                    gameCode: gameState.gameCode,
                    playerId: gameState.playerId,
                    roleConfig: roleConfig,
                    behaviorConfig: behaviorConfig
                });
                
                // Then deal roles
                const result = await callAPI('dealRoles', {
                    gameCode: gameState.gameCode,
                    playerId: gameState.playerId
                });
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to deal roles');
                }
                
                gameState.rolesDealt = true;
                saveGameState();
                
                showScreen('reveal-screen');
                showStatus('Roles dealt! Tap to reveal yours.');
                
            } catch (error) {
                showStatus('Failed to deal roles: ' + error.message, true);
                console.error(error);
            }
        }

        async function revealRole() {
            try {
                // Fetch role from API
                showStatus('Revealing role...');
                const result = await callAPI('getMyRole', {
                    gameCode: gameState.gameCode,
                    playerId: gameState.playerId
                });
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to get role');
                }
                
                gameState.myRole = result.role;
                gameState.myBehavior = result.behavior || 'no_behavior';
                gameState.revealStep = 1;
                saveGameState();
                
                // Hide the tabs - players get either power OR behavior, not both
                document.getElementById('role-nav-tabs').style.display = 'none';
                
                // Show the appropriate role
                if (gameState.myRole && gameState.myRole !== 'no_role') {
                    // Player has a power role
                    displayRoleCard(gameState.myRole);
                } else {
                    // Player has a behavior role instead
                    displayBehaviorCard(gameState.myBehavior);
                }
                showScreen('role-screen');
                
            } catch (error) {
                showStatus('Failed to reveal role: ' + error.message, true);
                console.error(error);
            }
        }

        function showPowerRole() {
            gameState.revealStep = 1;
            displayRoleCard(gameState.myRole);
            updateRoleNavTabs();
        }

        function showBehaviorRole() {
            gameState.revealStep = 2;
            displayBehaviorCard(gameState.myBehavior);
            updateRoleNavTabs();
        }

        function updateRoleNavTabs() {
            const powerTab = document.getElementById('power-tab');
            const behaviorTab = document.getElementById('behavior-tab');
            
            if (gameState.revealStep === 1) {
                powerTab.classList.add('active');
                behaviorTab.classList.remove('active');
            } else {
                powerTab.classList.remove('active');
                behaviorTab.classList.add('active');
            }
        }

        function hideRole() {
            showScreen('reveal-screen');
        }

        function backToLobby() {
            showScreen('lobby-screen');
        }

        function leaveLobby() {
            if (confirm('Leave this game?')) {
                stopPolling();
                clearGameState();
                showScreen('start-screen');
            }
        }

        // ==================== UI UPDATES ====================
        function updateLobbyDisplay() {
            document.getElementById('lobby-code-display').textContent = gameState.gameCode;
            document.getElementById('player-count').textContent = gameState.players.length;
            
            const list = document.getElementById('player-list');
            list.innerHTML = gameState.players.map((p, i) => `
                <li class="player-item">
                    <span class="player-number">${i + 1}</span>
                    <span class="player-name">${p.name}</span>
                    ${p.isHost ? '<span class="player-host">HOST</span>' : ''}
                </li>
            `).join('');
            
            // Show role config only for host
            const roleConfigEl = document.getElementById('role-config');
            const behaviorConfigEl = document.getElementById('behavior-config');
            const viewRolesLink = document.getElementById('view-roles-link');
            
            // Always show view roles link
            viewRolesLink.style.display = 'block';
            
            if (gameState.isHost) {
                roleConfigEl.style.display = 'block';
                behaviorConfigEl.style.display = 'block';
                initRoleCheckboxes();
                initBehaviorCheckboxes();
            } else {
                roleConfigEl.style.display = 'none';
                behaviorConfigEl.style.display = 'none';
            }
            
            // Show deal button only for host with 2+ players
            const dealBtn = document.getElementById('deal-roles-btn');
            if (gameState.isHost && gameState.players.length >= 2) {
                dealBtn.style.display = 'block';
            } else {
                dealBtn.style.display = 'none';
            }
            
            // Update status
            const status = document.getElementById('lobby-status');
            if (gameState.players.length < 2) {
                status.textContent = 'Need at least 2 players to start...';
            } else {
                status.textContent = `${gameState.players.length} players ready`;
            }
            
            updateRoleConfigInfo();
            updateBehaviorConfigInfo();
        }

        // Role configuration functions
        // Power Roles
        const ALL_SPECIAL_ROLES = ['police_chief', 'assassin', 'journalist', 'industrialist', 'union_organizer', 'constitutional_judge'];
        let roleConfig = {
            mode: 'random',
            count: 6,
            roles: [...ALL_SPECIAL_ROLES]
        };

        // Behavior Roles
        const ALL_BEHAVIOR_ROLES = ['feminist', 'misogynist', 'aristocrat', 'proletarian', 'pacifist', 'militarist', 'monarchist', 'revolutionary', 'prussian', 'bavarian', 'devout', 'atheist', 'academic', 'worker', 'veteran', 'hothead'];
        let behaviorConfig = {
            mode: 'random',
            count: 19,
            behaviors: [...ALL_BEHAVIOR_ROLES]
        };

        function initRoleCheckboxes() {
            const container = document.getElementById('role-checkboxes');
            if (container.children.length > 0) return; // Already initialized
            
            container.innerHTML = ALL_SPECIAL_ROLES.map(roleId => {
                const role = ROLES[roleId];
                return `
                    <label class="role-checkbox">
                        <input type="checkbox" value="${roleId}" checked onchange="updateSelectedRoles()">
                        ${role.title}
                    </label>
                `;
            }).join('');
        }

        function initBehaviorCheckboxes() {
            const container = document.getElementById('behavior-checkboxes');
            if (container.children.length > 0) return; // Already initialized
            
            container.innerHTML = ALL_BEHAVIOR_ROLES.map(behaviorId => {
                const behavior = BEHAVIOR_ROLES[behaviorId];
                return `
                    <label class="role-checkbox">
                        <input type="checkbox" value="${behaviorId}" checked onchange="updateSelectedBehaviors()">
                        ${behavior.title}
                    </label>
                `;
            }).join('');
        }

        function updateRoleMode() {
            const mode = document.querySelector('input[name="roleMode"]:checked').value;
            roleConfig.mode = mode;
            
            const countSelect = document.getElementById('role-count-select');
            const checkboxes = document.getElementById('role-checkboxes');
            
            countSelect.disabled = (mode !== 'count');
            checkboxes.style.display = (mode === 'specific') ? 'flex' : 'none';
            
            updateRoleConfigInfo();
        }

        function updateBehaviorMode() {
            const mode = document.querySelector('input[name="behaviorMode"]:checked').value;
            behaviorConfig.mode = mode;
            
            const countSelect = document.getElementById('behavior-count-select');
            const checkboxes = document.getElementById('behavior-checkboxes');
            
            countSelect.disabled = (mode !== 'count');
            checkboxes.style.display = (mode === 'specific') ? 'flex' : 'none';
            
            updateBehaviorConfigInfo();
        }

        function updateRoleCount() {
            roleConfig.count = parseInt(document.getElementById('role-count-select').value);
            updateRoleConfigInfo();
        }

        function updateBehaviorCount() {
            behaviorConfig.count = parseInt(document.getElementById('behavior-count-select').value);
            updateBehaviorConfigInfo();
        }

        function updateSelectedRoles() {
            const checkboxes = document.querySelectorAll('#role-checkboxes input:checked');
            roleConfig.roles = Array.from(checkboxes).map(cb => cb.value);
            updateRoleConfigInfo();
        }

        function updateSelectedBehaviors() {
            const checkboxes = document.querySelectorAll('#behavior-checkboxes input:checked');
            behaviorConfig.behaviors = Array.from(checkboxes).map(cb => cb.value);
            updateBehaviorConfigInfo();
        }

        function getSelectedRoleCount() {
            if (roleConfig.mode === 'random') {
                return ALL_SPECIAL_ROLES.length;
            } else if (roleConfig.mode === 'count') {
                return roleConfig.count;
            } else {
                return roleConfig.roles.length;
            }
        }

        function getSelectedBehaviorCount() {
            if (behaviorConfig.mode === 'random') {
                return ALL_BEHAVIOR_ROLES.length;
            } else if (behaviorConfig.mode === 'count') {
                return behaviorConfig.count;
            } else {
                return behaviorConfig.behaviors.length;
            }
        }

        function updateRoleConfigInfo() {
            const info = document.getElementById('role-config-info');
            const playerCount = gameState.players.length;
            const roleCount = getSelectedRoleCount();
            const noRoleCount = Math.max(0, playerCount - roleCount);
            
            if (playerCount === 0) {
                info.textContent = 'Extra players get "No Power Role"';
            } else if (noRoleCount > 0) {
                info.textContent = `${noRoleCount} player(s) get "No Power Role"`;
            } else {
                info.textContent = `All ${playerCount} players get a power role`;
            }
        }

        function updateBehaviorConfigInfo() {
            const info = document.getElementById('behavior-config-info');
            const playerCount = gameState.players.length;
            const behaviorCount = getSelectedBehaviorCount();
            
            if (behaviorCount === 0) {
                info.textContent = 'No behavior roles will be assigned';
            } else if (playerCount === 0) {
                info.textContent = `${behaviorCount} behavior roles available`;
            } else {
                const noBehaviorCount = Math.max(0, playerCount - behaviorCount);
                if (noBehaviorCount > 0) {
                    info.textContent = `${noBehaviorCount} player(s) get "No Behavior"`;
                } else {
                    info.textContent = `All players get a behavior role`;
                }
            }
        }

        function displayRoleCard(roleId, containerId = 'role-card-container') {
            const role = ROLES[roleId];
            if (!role) return;
            
            const container = document.getElementById(containerId);
            
            if (roleId === 'no_role') {
                container.innerHTML = `
                    <div class="no-role-card">
                        <div class="no-role-icon">∅</div>
                        <div class="no-role-text title-english">${role.title}</div>
                        <div class="no-role-german title-german">${role.subtitle}</div>
                        <div class="no-role-subtext">${role.powerDesc}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="role-card">
                    <div class="role-card-inner">
                        <div class="role-header">
                            <div class="role-icon">${role.icon}</div>
                            <div class="role-title title-english">${role.title}</div>
                            <div class="role-subtitle title-german">${role.subtitle}</div>
                        </div>
                        <div class="role-power">
                            ${role.powerName ? `<div class="power-name title-english">${role.powerName}</div>` : ''}
                            <div class="power-desc">${role.powerDesc}</div>
                            ${role.powerNote ? `<div class="power-note">${role.powerNote}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function displayBehaviorCard(behaviorId, containerId = 'role-card-container') {
            const behavior = BEHAVIOR_ROLES[behaviorId];
            if (!behavior) return;
            
            const container = document.getElementById(containerId);
            
            if (behaviorId === 'no_behavior') {
                container.innerHTML = `
                    <div class="no-role-card">
                        <div class="no-role-icon">∅</div>
                        <div class="no-role-text title-english">${behavior.title}</div>
                        <div class="no-role-german title-german">${behavior.subtitle}</div>
                        <div class="no-role-subtext">${behavior.behavior}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="role-card behavior-card">
                    <div class="role-card-inner">
                        <div class="role-header">
                            <div class="role-icon">${behavior.icon}</div>
                            <div class="role-title title-english">${behavior.title}</div>
                            <div class="role-subtitle title-german">${behavior.subtitle}</div>
                        </div>
                        <div class="role-power behavior-power">
                            <div class="power-desc behavior-desc">${behavior.behavior}</div>
                            <div class="behavior-reminder">Play this way throughout the game</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function copyGameCode() {
            navigator.clipboard.writeText(gameState.gameCode).then(() => {
                showStatus('Code copied!');
            }).catch(() => {
                showStatus('Failed to copy', true);
            });
        }

        // ==================== UTILITIES ====================
        function generateGameCode() {
            // 4 letters + 2 numbers (e.g., ABCD12)
            const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            const numbers = '0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            for (let i = 0; i < 2; i++) {
                code += numbers.charAt(Math.floor(Math.random() * numbers.length));
            }
            return code;
        }

        function generatePlayerId() {
            return 'p_' + Math.random().toString(36).substr(2, 9);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showStatus(message, isError = false) {
            const el = document.getElementById('status-message');
            el.textContent = message;
            el.className = 'status-message show' + (isError ? ' error' : '');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function saveGameState() {
            localStorage.setItem('weimarCrisis', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('weimarCrisis');
            if (saved) {
                gameState = JSON.parse(saved);
                return true;
            }
            return false;
        }

        function clearGameState() {
            gameState = {
                gameCode: null,
                playerId: null,
                playerName: null,
                isHost: false,
                players: [],
                myRole: null,
                rolesDealt: false
            };
            localStorage.removeItem('weimarCrisis');
        }

        // Polling for player/game updates
        function startPolling() {
            stopPolling(); // Clear any existing timer
            
            pollTimer = setInterval(async () => {
                try {
                    // Get latest player list
                    const playersResult = await callAPI('getPlayers', {
                        gameCode: gameState.gameCode
                    });
                    
                    if (playersResult.success) {
                        gameState.players = playersResult.players;
                        
                        // Check if roles were dealt
                        if (playersResult.rolesDealt && !gameState.rolesDealt) {
                            gameState.rolesDealt = true;
                            saveGameState();
                            stopPolling();
                            showScreen('reveal-screen');
                            showStatus('Roles have been dealt! Tap to reveal yours.');
                            return;
                        }
                        
                        // Update lobby display if we're on that screen
                        if (document.getElementById('lobby-screen').classList.contains('active')) {
                            updateLobbyDisplay();
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, POLL_INTERVAL);
        }

        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }

        // ==================== INIT ====================
        function init() {
            // Check for saved game state
            if (loadGameState() && gameState.gameCode) {
                if (gameState.rolesDealt && gameState.myRole) {
                    showScreen('reveal-screen');
                } else if (gameState.isHost) {
                    updateLobbyDisplay();
                    showScreen('lobby-screen');
                } else {
                    showScreen('waiting-screen');
                }
            }
            
            // Handle Enter key on inputs
            document.getElementById('join-code-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinWithCode();
            });
            document.getElementById('player-name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') confirmName();
            });
        }

        init();
    </script>
</body>
</html>
