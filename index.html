<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Weimar Crisis — Expansion Roles</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=UnifrakturCook:wght@700&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Secret Hitler Color Palette */
            --fascist-red: #C23B22;
            --fascist-dark: #8B2500;
            --fascist-light: #E8654A;
            --liberal-blue: #4A6FA5;
            --liberal-dark: #2C4A6E;
            --liberal-light: #6B8FC5;
            --cream: #D4C5A9;
            --cream-light: #E8DFD0;
            --tan: #B8A888;
            --brown: #2C2416;
            --brown-light: #5A4A32;
            --gold: #C9A227;
            --bg-red: #E8654A;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--bg-red);
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 20px,
                    rgba(0,0,0,0.03) 20px,
                    rgba(0,0,0,0.03) 40px
                );
            color: var(--brown);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ============================================
           TYPOGRAPHY
           ============================================ */
        .title-english {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .title-german {
            font-family: 'UnifrakturCook', cursive;
            font-weight: 700;
        }

        /* ============================================
           SCREENS
           ============================================ */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .screen.active {
            display: flex;
        }

        /* ============================================
           START SCREEN
           ============================================ */
        #start-screen {
            text-align: center;
        }

        .logo-container {
            margin-bottom: 40px;
        }

        .logo-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: var(--brown);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--cream);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .logo-icon svg {
            width: 70px;
            height: 70px;
            fill: var(--cream);
        }

        .logo-title {
            font-size: 3rem;
            color: var(--cream);
            text-shadow: 3px 3px 0 var(--brown), 4px 4px 0 rgba(0,0,0,0.2);
            margin-bottom: 8px;
        }

        .logo-fraktur {
            font-family: 'UnifrakturCook', cursive;
            font-size: 2.6rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .logo-subtitle {
            font-family: 'UnifrakturCook', cursive;
            font-size: 1.6rem;
            color: var(--cream);
            opacity: 0.7;
            margin-top: 4px;
        }

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 320px;
        }

        .btn {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 0.1em;
            padding: 16px 32px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: var(--brown);
            color: var(--cream);
            border: 3px solid var(--cream);
            box-shadow: 0 4px 0 var(--fascist-dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 var(--fascist-dark);
        }

        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--fascist-dark);
        }

        .btn-secondary {
            background: var(--cream);
            color: var(--brown);
            border: 3px solid var(--brown);
            box-shadow: 0 4px 0 var(--tan);
        }

        .btn-inspect {
            background: transparent;
            color: var(--cream);
            border: 2px solid var(--cream);
            font-size: 0.9rem;
            padding: 10px 20px;
            opacity: 0.7;
            margin-top: 16px;
        }

        .btn-inspect:hover {
            opacity: 1;
            background: rgba(212, 197, 169, 0.1);
        }

        /* ============================================
           INSPECT ROLES SCREEN
           ============================================ */
        #inspect-screen,
        #lobby-screen {
            overflow-y: auto;
            justify-content: flex-start;
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .inspect-container {
            width: 100%;
            max-width: 1400px;
            padding: 20px;
        }

        .inspect-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--cream);
            text-align: center;
            margin-bottom: 24px;
            letter-spacing: 0.1em;
        }

        .inspect-role-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inspect-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
            width: 100%;
        }

        .inspect-card-grid .role-card,
        .inspect-card-grid .behavior-card {
            width: 100%;
            min-height: 320px;
        }

        .inspect-card-grid .no-role-card {
            width: 100%;
            height: auto;
            min-height: 280px;
        }

        .inspect-role-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--cream);
            border: 3px solid var(--brown);
            color: var(--brown);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .inspect-role-btn:hover {
            background: var(--brown);
            color: var(--cream);
            transform: translateY(-2px);
        }

        .inspect-role-btn:active {
            transform: translateY(0);
        }

        .inspect-role-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .join-input-group {
            display: flex;
            gap: 8px;
        }

        .join-input {
            flex: 1;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.15em;
            padding: 16px;
            border: 3px solid var(--brown);
            background: var(--cream);
            color: var(--brown);
            text-align: center;
            text-transform: uppercase;
        }

        .join-input::placeholder {
            color: var(--tan);
            opacity: 1;
        }

        .btn-join {
            padding: 16px 24px;
            font-size: 1.2rem;
        }

        /* ============================================
           NAME INPUT SCREEN
           ============================================ */
        .name-container {
            background: var(--cream);
            border: 4px solid var(--brown);
            padding: 32px;
            max-width: 360px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .name-container::before,
        .name-container::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid var(--brown);
        }

        .name-container::before {
            top: 8px;
            left: 8px;
            border-right: none;
            border-bottom: none;
        }

        .name-container::after {
            bottom: 8px;
            right: 8px;
            border-left: none;
            border-top: none;
        }

        .name-label {
            font-size: 1.5rem;
            color: var(--brown);
            margin-bottom: 16px;
        }

        .name-input {
            width: 100%;
            font-family: 'Crimson Pro', serif;
            font-size: 1.3rem;
            padding: 14px;
            border: 3px solid var(--brown);
            background: white;
            color: var(--brown);
            text-align: center;
            margin-bottom: 20px;
        }

        /* ============================================
           LOBBY SCREEN
           ============================================ */
        .lobby-container {
            background: var(--cream);
            border: 4px solid var(--brown);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .lobby-container::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--brown);
            padding: 4px 20px;
            color: var(--cream);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 0.2em;
        }

        .lobby-code {
            background: var(--brown);
            color: var(--cream);
            padding: 12px 24px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .lobby-code-label {
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            opacity: 0.7;
        }

        .lobby-code-value {
            font-size: 2rem;
            letter-spacing: 0.2em;
        }

        .lobby-players {
            margin: 20px 0;
            text-align: left;
        }

        .lobby-players-title {
            font-size: 1rem;
            color: var(--brown);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--tan);
        }

        .player-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--tan);
        }

        .player-number {
            width: 28px;
            height: 28px;
            background: var(--brown);
            color: var(--cream);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
        }

        .player-name {
            flex: 1;
            font-size: 1.15rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
        }

        .player-host {
            font-size: 0.7rem;
            background: var(--gold);
            color: var(--brown);
            padding: 2px 8px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
        }

        .lobby-status {
            font-size: 1rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.08em;
            color: var(--brown-light);
            margin: 16px 0;
        }

        .lobby-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        /* ============================================
           ROLE CONFIGURATION
           ============================================ */
        .role-config {
            background: rgba(44, 36, 22, 0.1);
            border: 1px solid var(--brown-light);
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
        }

        .role-config-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
            color: var(--brown);
        }

        .role-config-mode {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .role-mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
            color: var(--brown);
        }

        .role-mode-option input[type="radio"] {
            accent-color: var(--red);
        }

        .role-mode-option select {
            padding: 6px 10px;
            font-size: 0.9rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
            border: 2px solid var(--brown-light);
            background: var(--cream);
            color: var(--brown);
            border-radius: 2px;
            min-width: 70px;
        }

        .role-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--brown-light);
        }

        .role-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--cream);
            border: 2px solid var(--brown-light);
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }

        .role-checkbox:has(input:checked) {
            background: var(--brown);
            color: var(--cream);
            border-color: var(--brown);
        }

        .role-checkbox input {
            display: none;
        }

        .role-config-info {
            font-size: 0.85rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
            color: var(--brown-light);
            margin-top: 12px;
            text-align: center;
        }

        .role-hint {
            font-size: 0.75rem;
            font-weight: normal;
            opacity: 0.7;
            font-family: 'Crimson Pro', serif;
        }

        .view-roles-link {
            text-align: center;
            margin-bottom: 16px;
        }

        .view-roles-link a {
            color: var(--cream);
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .view-roles-link a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .view-roles-link i {
            margin-right: 4px;
        }

        /* ============================================
           WAITING SCREEN
           ============================================ */
        .waiting-container {
            text-align: center;
            color: var(--cream);
        }

        .waiting-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--cream);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .waiting-text {
            font-size: 1.5rem;
            text-shadow: 2px 2px 0 var(--brown);
        }

        .waiting-subtext {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 8px;
        }

        /* ============================================
           REVEAL SCREEN
           ============================================ */
        .reveal-container {
            text-align: center;
        }

        .reveal-card {
            width: 280px;
            height: 400px;
            background: var(--brown);
            border: 4px solid var(--cream);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        .reveal-card:hover {
            transform: scale(1.02);
        }

        .reveal-card:active {
            transform: scale(0.98);
        }

        .reveal-card-inner {
            text-align: center;
            color: var(--cream);
        }

        .reveal-question {
            font-size: 8rem;
            font-family: 'Bebas Neue', sans-serif;
            line-height: 1;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .reveal-text {
            font-size: 1.2rem;
            margin-top: 16px;
            letter-spacing: 0.1em;
        }

        .reveal-german {
            font-size: 1rem;
            margin-top: 8px;
            opacity: 0.7;
        }

        /* Decorative corners on reveal card */
        .reveal-card::before,
        .reveal-card::after,
        .reveal-card .corner-bl,
        .reveal-card .corner-br {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid var(--cream);
        }

        .reveal-card::before {
            top: 12px;
            left: 12px;
            border-right: none;
            border-bottom: none;
        }

        .reveal-card::after {
            top: 12px;
            right: 12px;
            border-left: none;
            border-bottom: none;
        }

        .reveal-card .corner-bl {
            bottom: 12px;
            left: 12px;
            border-right: none;
            border-top: none;
        }

        .reveal-card .corner-br {
            bottom: 12px;
            right: 12px;
            border-left: none;
            border-top: none;
        }

        /* ============================================
           ROLE CARD DISPLAY
           ============================================ */
        .role-card-container {
            perspective: 1000px;
        }

        .role-card {
            width: 300px;
            min-height: 380px;
            background: var(--cream);
            border: 3px solid var(--brown);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        .role-card-inner {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Header section */
        .role-header {
            background: var(--tan);
            padding: 16px 12px;
            text-align: center;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--brown);
        }

        .role-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: var(--brown);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .role-icon svg {
            width: 40px;
            height: 40px;
            fill: var(--cream);
        }

        .role-title {
            font-size: 1.6rem;
            color: var(--brown);
            line-height: 1.1;
        }

        .role-subtitle {
            font-size: 1.3rem;
            color: var(--brown-light);
            margin-top: 4px;
        }

        /* Power section */
        .role-power {
            flex: 1;
            padding: 0 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .power-name-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .power-name {
            font-size: 1.4rem;
            font-family: 'Bebas Neue', sans-serif;
            color: var(--brown);
            letter-spacing: 0.05em;
        }

        .once-badge {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            background: var(--red);
            color: white;
            padding: 2px 6px;
            border-radius: 2px;
        }

        .power-desc {
            font-size: 1rem;
            color: var(--brown);
            text-align: center;
            line-height: 1.5;
        }

        .power-note {
            font-size: 0.85rem;
            color: var(--brown-light);
            text-align: center;
            margin-top: 12px;
            font-style: italic;
        }

        /* Quote footer */
        .role-quote {
            margin-top: auto;
            padding: 12px;
            background: var(--brown);
            color: var(--cream);
            text-align: center;
            position: relative;
        }

        .quote-text {
            font-size: 0.8rem;
            font-style: italic;
            line-height: 1.35;
        }

        .quote-attr {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* ============================================
           REFERENCE CARD
           ============================================ */
        .ref-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px solid var(--tan);
        }

        .ref-icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            background: var(--brown);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ref-icon svg {
            width: 18px;
            height: 18px;
            fill: var(--cream);
        }

        .ref-text {
            font-size: 0.85rem;
            color: var(--brown);
        }

        .ref-text strong {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
        }

        /* ============================================
           BACK BUTTON
           ============================================ */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: var(--brown);
            border: 3px solid var(--cream);
            color: var(--cream);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .back-btn:hover {
            background: var(--brown-light);
        }

        .leave-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 14px;
            background: transparent;
            border: 2px solid rgba(235, 222, 199, 0.4);
            color: rgba(235, 222, 199, 0.6);
            font-size: 0.75rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            z-index: 1000;
        }

        .leave-btn:hover {
            background: rgba(139, 69, 69, 0.8);
            border-color: var(--cream);
            color: var(--cream);
        }

        .leave-btn i {
            margin-right: 5px;
        }

        /* ============================================
           STATUS MESSAGES
           ============================================ */
        .status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--brown);
            color: var(--cream);
            padding: 12px 24px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            z-index: 200;
        }

        .status-message.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .status-message.error {
            background: var(--fascist-red);
        }

        /* ============================================
           PRINT MODE (for reference cards)
           ============================================ */
        @media print {
            body {
                background: white;
                padding: 8px;
            }
            .screen { display: block !important; }
            #start-screen, #name-screen, #lobby-screen, 
            #waiting-screen, #reveal-screen { display: none !important; }
            .back-btn { display: none; }
        }

        /* ============================================
           MOBILE OPTIMIZATIONS
           ============================================ */
        @media (max-width: 360px) {
            .role-card {
                width: 280px;
                height: 400px;
            }
            .inspect-card-grid .role-card,
            .inspect-card-grid .behavior-card,
            .inspect-card-grid .no-role-card {
                width: 100%;
            }
            .role-title { font-size: 1.4rem; }
            .role-subtitle { font-size: 1.1rem; }
            .power-desc { font-size: 0.85rem; }
        }

        @media (max-width: 600px) {
            .inspect-card-grid {
                grid-template-columns: 1fr;
            }
            .inspect-card-grid .role-card,
            .inspect-card-grid .behavior-card,
            .inspect-card-grid .no-role-card {
                width: 100%;
                max-width: 320px;
                margin: 0 auto;
            }
        }

        /* ============================================
           NO ROLE CARD (when not assigned)
           ============================================ */
        .no-role-card {
            width: 300px;
            height: 440px;
            background: var(--cream);
            border: 4px solid var(--brown);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 32px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        .no-role-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .no-role-text {
            font-size: 1.3rem;
            color: var(--brown);
            margin-bottom: 8px;
        }

        .no-role-german {
            font-size: 1.1rem;
            color: var(--brown-light);
        }

        .no-role-subtext {
            font-size: 0.9rem;
            color: var(--brown-light);
            margin-top: 16px;
            font-style: italic;
        }

        /* Behavior Card */
        .behavior-card {
            border-color: var(--blue);
        }

        .behavior-power {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 24px 16px;
        }

        .behavior-desc {
            font-size: 1.15rem;
            line-height: 1.6;
            color: var(--brown);
        }

        .behavior-reminder {
            margin-top: 24px;
            font-size: 0.85rem;
            color: var(--brown-light);
            font-style: italic;
        }

        /* Inspect Section Title */
        .inspect-section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            color: var(--cream);
            letter-spacing: 0.1em;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        /* Role Navigation Tabs */
        .role-screen-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .role-nav-tabs {
            display: flex;
            gap: 8px;
        }

        .role-nav-tab {
            padding: 10px 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 0.05em;
            background: var(--cream);
            color: var(--brown);
            border: 2px solid var(--brown);
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .role-nav-tab.active {
            opacity: 1;
            background: var(--brown);
            color: var(--cream);
        }

        .role-nav-tab:hover {
            opacity: 1;
        }

        /* ============================================
           COUNTDOWN OVERLAY (#6)
           ============================================ */
        .countdown-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(44, 36, 22, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .countdown-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .countdown-number {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 12rem;
            color: var(--cream);
            text-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        .countdown-number.pop {
            animation: countdownPop 0.8s ease-out;
        }
        @keyframes countdownPop {
            0% { transform: scale(2); opacity: 0; }
            50% { transform: scale(0.9); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ============================================
           CARD FLIP ANIMATION (#7)
           ============================================ */
        .reveal-card.flipping {
            animation: cardFlip 0.8s ease-in-out;
            transform-style: preserve-3d;
        }
        @keyframes cardFlip {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(90deg) scale(0.95); }
            100% { transform: rotateY(0deg) scale(1); }
        }

        /* ============================================
           OFFLINE BANNER (#10)
           ============================================ */
        .offline-banner {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: var(--fascist-red);
            color: white;
            text-align: center;
            padding: 8px 16px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .offline-banner.visible {
            transform: translateY(0);
        }

        /* ============================================
           PLAYER AVATARS (#5)
           ============================================ */
        .player-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
            flex-shrink: 0;
        }

        /* ============================================
           QR CODE (#4)
           ============================================ */
        .qr-section {
            margin: 12px auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #qr-code {
            display: flex;
            justify-content: center;
        }
        .qr-section canvas,
        .qr-section img {
            border: 3px solid var(--brown) !important;
        }
        .qr-label {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.75rem;
            letter-spacing: 0.15em;
            color: var(--brown-light);
            margin-top: 6px;
        }

        /* ============================================
           PULL TO REFRESH (#12)
           ============================================ */
        .pull-indicator {
            text-align: center;
            padding: 0;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            color: var(--brown-light);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s, padding 0.2s;
        }
        .pull-indicator.visible {
            max-height: 40px;
            padding: 8px;
        }
        .pull-indicator.refreshing i {
            animation: spin 1s linear infinite;
        }

        /* ============================================
           ENHANCED TOASTS (#8)
           ============================================ */
        .status-message.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-message i {
            font-size: 1rem;
        }

        /* ============================================
           SWIPE HINT (#11)
           ============================================ */
        .swipe-hint {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            color: var(--cream);
            opacity: 0.5;
            text-align: center;
            margin-top: 8px;
        }
    </style>
</head>
<body>

    <!-- Offline Banner (#10) -->
    <div class="offline-banner" id="offline-banner">
        <i class="fas fa-wifi"></i> No connection
    </div>

    <!-- Countdown Overlay (#6) -->
    <div class="countdown-overlay" id="countdown-overlay">
        <div class="countdown-number" id="countdown-number">3</div>
    </div>

    <!-- Leave/Reset Button (always visible except on start screen) -->
    <button class="leave-btn" id="leave-btn" style="display: none;" onclick="leaveGame()">
        <i class="fas fa-sign-out-alt"></i> LEAVE
    </button>

    <!-- ==================== START SCREEN ==================== -->
    <div id="start-screen" class="screen active">
        <div class="logo-container">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 4l5 2.18V11H7V7.18L12 5z"/>
                </svg>
            </div>
            <h1 class="logo-title title-english">WEIMAR CRISIS</h1>
            <h2 class="logo-subtitle title-german">Kriſe in Weimar</h2>
        </div>
        <div class="start-buttons">
            <button class="btn btn-primary" onclick="showScreen('name-screen', true)">Create New Game</button>
            <div class="join-input-group">
                <input type="text" class="join-input" id="join-code-input" placeholder="GAME CODE" maxlength="10">
                <button class="btn btn-secondary btn-join" onclick="joinWithCode()">Join</button>
            </div>
            <button class="btn btn-inspect" onclick="showScreen('inspect-screen')">Inspect Roles</button>
        </div>
    </div>

    <!-- ==================== INSPECT ROLES SCREEN ==================== -->
    <div id="inspect-screen" class="screen">
        <button class="back-btn" onclick="showScreen('start-screen')">←</button>
        <div class="inspect-container">
            <h2 class="inspect-title title-english">Inspect Roles</h2>
            <div class="inspect-role-list" id="inspect-role-list">
                <!-- Role buttons will be generated here -->
            </div>
        </div>
    </div>

    <!-- ==================== INSPECT ROLE DISPLAY SCREEN ==================== -->
    <div id="inspect-role-screen" class="screen">
        <button class="back-btn" onclick="showScreen('inspect-screen')">←</button>
        <div class="role-card-container" id="inspect-role-card-container">
            <!-- Role card will be inserted here -->
        </div>
    </div>

    <!-- ==================== NAME INPUT SCREEN ==================== -->
    <div id="name-screen" class="screen">
        <button class="back-btn" onclick="showScreen('start-screen')">←</button>
        <div class="name-container">
            <h2 class="name-label title-english">Enter Your Name</h2>
            <input type="text" class="name-input" id="player-name-input" placeholder="Your Name" maxlength="20">
            <button class="btn btn-primary" onclick="confirmName()" style="width: 100%;">Continue</button>
        </div>
    </div>

    <!-- ==================== LOBBY SCREEN ==================== -->
    <div id="lobby-screen" class="screen">
        <button class="back-btn" onclick="leaveLobby()">←</button>
        <div class="lobby-container">
            <div class="lobby-code">
                <div class="lobby-code-label title-english">Game Code</div>
                <div class="lobby-code-value title-english" id="lobby-code-display">XXXX00</div>
            </div>

            <!-- QR Code (#4) -->
            <div class="qr-section" id="qr-section" style="display: none;">
                <div id="qr-code"></div>
                <div class="qr-label">Scan to join</div>
            </div>

            <!-- Pull to refresh indicator (#12) -->
            <div class="pull-indicator" id="pull-indicator">
                <i class="fas fa-arrow-down"></i> Release to refresh
            </div>

            <div class="lobby-players">
                <div class="lobby-players-title title-english">
                    Players (<span id="player-count">0</span>)
                </div>
                <ul class="player-list" id="player-list">
                    <!-- Players will be added dynamically -->
                </ul>
            </div>

            <!-- View Roles Link -->
            <div class="view-roles-link" id="view-roles-link" style="display: none;">
                <a href="#" onclick="showScreen('inspect-screen'); return false;">
                    <i class="fas fa-info-circle"></i> View all role descriptions
                </a>
            </div>

            <!-- Power Role Configuration (Host Only) -->
            <div class="role-config" id="role-config" style="display: none;">
                <div class="role-config-title title-english">Power Roles <span class="role-hint">(special one-time abilities)</span></div>
                <div class="role-config-mode">
                    <label class="role-mode-option">
                        <input type="radio" name="roleMode" value="random" checked onchange="updateRoleMode()">
                        <span>All roles (random)</span>
                    </label>
                    <label class="role-mode-option">
                        <input type="radio" name="roleMode" value="count" onchange="updateRoleMode()">
                        <span>Number of roles:</span>
                        <select id="role-count-select" onchange="updateRoleCount()" disabled>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6" selected>6</option>
                        </select>
                    </label>
                    <label class="role-mode-option">
                        <input type="radio" name="roleMode" value="specific" onchange="updateRoleMode()">
                        <span>Choose specific:</span>
                    </label>
                </div>
                <div class="role-checkboxes" id="role-checkboxes" style="display: none;">
                    <!-- Role checkboxes will be generated -->
                </div>
                <div class="role-config-info" id="role-config-info">
                    Extra players will receive "No Power Role"
                </div>
            </div>

            <!-- Behavior Role Configuration (Host Only) -->
            <div class="role-config" id="behavior-config" style="display: none;">
                <div class="role-config-title title-english">Behavior Roles <span class="role-hint">(for players without power roles)</span></div>
                <div class="role-config-mode">
                    <label class="role-mode-option">
                        <input type="radio" name="behaviorMode" value="none" onchange="updateBehaviorMode()">
                        <span>None (no behavior roles)</span>
                    </label>
                    <label class="role-mode-option">
                        <input type="radio" name="behaviorMode" value="random" checked onchange="updateBehaviorMode()">
                        <span>Random (fill remaining players)</span>
                    </label>
                    <label class="role-mode-option">
                        <input type="radio" name="behaviorMode" value="specific" onchange="updateBehaviorMode()">
                        <span>Choose specific:</span>
                    </label>
                </div>
                <div class="role-checkboxes" id="behavior-checkboxes" style="display: none;">
                    <!-- Behavior checkboxes will be generated -->
                </div>
                <div class="role-config-info" id="behavior-config-info">
                    Remaining players get behavior roles
                </div>
            </div>

            <div class="lobby-status" id="lobby-status">Waiting for players...</div>

            <div class="lobby-actions">
                <button class="btn btn-primary" id="deal-roles-btn" onclick="dealRoles()" style="display: none;">
                    Deal Expansion Roles
                </button>
                <button class="btn btn-secondary" onclick="copyGameCode()">Copy Game Code</button>
            </div>
        </div>
    </div>

    <!-- ==================== WAITING SCREEN ==================== -->
    <div id="waiting-screen" class="screen">
        <div class="waiting-container">
            <div class="waiting-spinner"></div>
            <div class="waiting-text title-english" id="waiting-text">Waiting for Host</div>
            <div class="waiting-subtext" id="waiting-subtext">The host will deal roles soon...</div>
        </div>
    </div>

    <!-- ==================== REVEAL SCREEN ==================== -->
    <div id="reveal-screen" class="screen">
        <button class="back-btn" onclick="backToLobby()">←</button>
        <div class="reveal-container">
            <div class="reveal-card" onclick="revealRole()">
                <div class="corner-bl"></div>
                <div class="corner-br"></div>
                <div class="reveal-card-inner">
                    <div class="reveal-question">?</div>
                    <div class="reveal-text title-english">Tap to Reveal</div>
                    <div class="reveal-german title-german">Tippen zum Enthüllen</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== ROLE DISPLAY SCREEN ==================== -->
    <div id="role-screen" class="screen">
        <button class="back-btn" onclick="hideRole()">←</button>
        <div class="role-screen-content">
            <div class="role-nav-tabs" id="role-nav-tabs">
                <button class="role-nav-tab active" id="power-tab" onclick="showPowerRole()">Power</button>
                <button class="role-nav-tab" id="behavior-tab" onclick="showBehaviorRole()">Behavior</button>
            </div>
            <div class="role-card-container" id="role-card-container">
                <!-- Role card will be inserted here -->
            </div>
            <div class="swipe-hint" id="swipe-hint" style="display: none;">
                <i class="fas fa-hand-pointer"></i> Swipe left/right to switch tabs
            </div>
        </div>
    </div>

    <!-- ==================== STATUS MESSAGE ==================== -->
    <div class="status-message" id="status-message"></div>

    <!-- ==================== ROLE DATA ==================== -->
    <script>
        const ROLES = {
            'police_chief': {
                title: 'Police Chief',
                subtitle: 'Polizeipräſident',
                powerName: 'Arrest',
                powerDesc: 'Once per game, during any discussion, arrest one player. They cannot serve as President or Chancellor until pardoned by a sitting President.',
                powerNote: 'Arrested players may still vote and speak.',
                icon: `<i class="fas fa-handcuffs"></i>`
            },
            'assassin': {
                title: 'The Assassin',
                subtitle: 'Der Attentäter',
                powerName: 'Assassinate',
                powerDesc: 'Once per game, during any discussion, eliminate one player from the game permanently.',
                powerNote: 'Cannot use while arrested. Killing Hitler = Liberal victory.',
                icon: `<i class="fas fa-crosshairs"></i>`
            },
            'journalist': {
                title: 'The Journalist',
                subtitle: 'Der Reporter',
                powerName: 'Exposé',
                powerDesc: 'Once per game, after a legislative session, force the President or Chancellor to truthfully reveal one policy they discarded.',
                powerNote: null,
                icon: `<i class="fas fa-newspaper"></i>`
            },
            'industrialist': {
                title: 'The Industrialist',
                subtitle: 'Der Großinduſtrielle',
                powerName: 'Fund',
                powerDesc: 'Once per game, during voting, fund the proposed government. The election passes automatically regardless of votes.',
                powerNote: null,
                icon: `<i class="fas fa-landmark"></i>`
            },
            'union_organizer': {
                title: 'Union Organizer',
                subtitle: 'Der Gewerkſchaftsführer',
                powerName: 'General Strike',
                powerDesc: 'Once per game, during voting, call a general strike. The election fails automatically regardless of votes.',
                powerNote: null,
                icon: `<i class="fas fa-fist-raised"></i>`
            },
            'constitutional_judge': {
                title: 'Constitutional Judge',
                subtitle: 'Der Verfaſſungsrichter',
                powerName: 'Judicial Review',
                powerDesc: 'Once per game, block any executive power (Investigation, Special Election, or Execution) as it is used. That power is lost.',
                powerNote: null,
                icon: `<i class="fas fa-gavel"></i>`
            },
            'no_role': {
                title: 'No Expansion Role',
                subtitle: 'Keine Erweiterungsrolle',
                powerName: null,
                powerDesc: 'You have no expansion role this game. Play with your standard Secret Hitler role only.',
                powerNote: null,
                icon: `<i class="fas fa-ban"></i>`
            }
        };

        // ==================== BEHAVIOR ROLES ====================
        const BEHAVIOR_ROLES = {
            'feminist': {
                title: 'The Feminist',
                subtitle: 'Die Feministin',
                behavior: 'You are distrustful of men in positions of power.',
                icon: `<i class="fas fa-venus"></i>`
            },
            'misogynist': {
                title: 'The Misogynist',
                subtitle: 'Der Frauenfeind',
                behavior: 'You are distrustful of women in positions of power.',
                icon: `<i class="fas fa-mars"></i>`
            },
            'aristocrat': {
                title: 'The Aristocrat',
                subtitle: 'Der Ariſtokrat',
                behavior: 'You distrust common workers and prefer refined, educated types.',
                icon: `<i class="fas fa-gem"></i>`
            },
            'proletarian': {
                title: 'The Proletarian',
                subtitle: 'Der Proletarier',
                behavior: 'You distrust the wealthy and elite classes.',
                icon: `<i class="fas fa-hammer"></i>`
            },
            'pacifist': {
                title: 'The Pacifist',
                subtitle: 'Der Paziſist',
                behavior: 'You distrust anyone who speaks of violence or military force.',
                icon: `<i class="fas fa-dove"></i>`
            },
            'militarist': {
                title: 'The Militarist',
                subtitle: 'Der Militariſt',
                behavior: 'You distrust anyone who seems weak, indecisive, or cowardly.',
                icon: `<i class="fas fa-shield-halved"></i>`
            },
            'monarchist': {
                title: 'The Monarchist',
                subtitle: 'Der Monarchiſt',
                behavior: 'You secretly miss the Kaiser and distrust republicans and democrats.',
                icon: `<i class="fas fa-crown"></i>`
            },
            'revolutionary': {
                title: 'The Revolutionary',
                subtitle: 'Der Revolutionär',
                behavior: 'You distrust moderates and anyone who resists radical change.',
                icon: `<i class="fas fa-fire"></i>`
            },
            'prussian': {
                title: 'The Prussian',
                subtitle: 'Der Preuße',
                behavior: 'You value discipline and order. You distrust those who lack it.',
                icon: `<i class="fas fa-chess-rook"></i>`
            },
            'bavarian': {
                title: 'The Bavarian',
                subtitle: 'Der Bayer',
                behavior: 'You distrust centralized Berlin authority and Prussian influence.',
                icon: `<i class="fas fa-beer-mug-empty"></i>`
            },
            'devout': {
                title: 'The Devout',
                subtitle: 'Der Fromme',
                behavior: 'You distrust atheists, secularists, and the morally loose.',
                icon: `<i class="fas fa-cross"></i>`
            },
            'atheist': {
                title: 'The Atheist',
                subtitle: 'Der Atheiſt',
                behavior: 'You distrust the overtly religious and those who invoke God.',
                icon: `<i class="fas fa-atom"></i>`
            },
            'academic': {
                title: 'The Academic',
                subtitle: 'Der Akademiker',
                behavior: 'You distrust the uneducated and those who rely on emotion over reason.',
                icon: `<i class="fas fa-graduation-cap"></i>`
            },
            'worker': {
                title: 'The Worker',
                subtitle: 'Der Arbeiter',
                behavior: 'You distrust intellectuals, academics, and elites who never labored.',
                icon: `<i class="fas fa-wrench"></i>`
            },
            'veteran': {
                title: 'The Veteran',
                subtitle: 'Der Veteran',
                behavior: 'You only truly trust fellow soldiers who served in the war.',
                icon: `<i class="fas fa-medal"></i>`
            },
            'hothead': {
                title: 'The Hothead',
                subtitle: 'Der Hitzkopf',
                behavior: 'You make decisions based on emotion and instinct, not logic.',
                icon: `<i class="fas fa-bolt"></i>`
            },
            'no_behavior': {
                title: 'No Behavior Role',
                subtitle: 'Keine Verhaltensrolle',
                behavior: 'You have no assigned behavior. Play as yourself.',
                icon: `<i class="fas fa-ban"></i>`
            }
        };

        // ==================== APP STATE ====================
        let gameState = {
            gameCode: null,
            playerId: null,
            playerName: null,
            isHost: false,
            players: [],
            myRole: null,
            myBehavior: null,
            rolesDealt: false,
            revealStep: 0  // 0 = not revealed, 1 = power shown, 2 = behavior shown
        };

        // API endpoint - Apps Script Web App URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbypANwSZmFjgPWxgzYTVwAoZUElXweZj_qt2xTo2N5uAsXAtm7bPxAWB4BiXZGICZ4T/exec';
        
        // Polling interval (ms)
        const POLL_INTERVAL = 3000;
        let pollTimer = null;

        // ==================== API HELPER (with auto-reconnect #9) ====================
        async function callAPI(action, params = {}) {
            const maxRetries = 3;
            let lastError;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: JSON.stringify({ action, ...params })
                    });
                    return await response.json();
                } catch (error) {
                    lastError = error;
                    console.error(`API attempt ${attempt + 1} failed:`, error);
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        showStatus(`Reconnecting... (attempt ${attempt + 2})`, true);
                        await new Promise(r => setTimeout(r, delay));
                    }
                }
            }
            throw lastError;
        }

        // ==================== SCREEN NAVIGATION ====================
        function showScreen(screenId, isCreating = false) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // Show leave button on all screens except start screen
            const leaveBtn = document.getElementById('leave-btn');
            leaveBtn.style.display = (screenId === 'start-screen') ? 'none' : 'block';
            
            if (screenId === 'name-screen') {
                gameState.isHost = isCreating;
                document.getElementById('player-name-input').focus();
            }
            
            if (screenId === 'inspect-screen') {
                populateInspectRoleList();
            }
        }

        // ==================== LEAVE GAME ====================
        function leaveGame() {
            if (confirm('Leave the game and return to the start screen?')) {
                // Stop polling first
                stopPolling();
                
                // Clear ALL stored game data
                localStorage.removeItem('weimarCrisis');
                
                // Reset game state completely
                gameState = {
                    gameCode: null,
                    playerId: null,
                    playerName: null,
                    isHost: false,
                    players: [],
                    myRole: null,
                    myBehaviorRole: null
                };
                
                // Go to start screen
                showScreen('start-screen');
            }
        }

        // ==================== INSPECT ROLES ====================
        function populateInspectRoleList() {
            const container = document.getElementById('inspect-role-list');
            const powerRoleIds = [...ALL_SPECIAL_ROLES, 'no_role'];
            const behaviorRoleIds = [...ALL_BEHAVIOR_ROLES, 'no_behavior'];

            function renderPowerCard(roleId) {
                const role = ROLES[roleId];
                if (!role) return '';
                if (roleId === 'no_role') {
                    return `
                        <div class="no-role-card">
                            <div class="no-role-icon">\u2205</div>
                            <div class="no-role-text title-english">${role.title}</div>
                            <div class="no-role-german title-german">${role.subtitle}</div>
                            <div class="no-role-subtext">${role.powerDesc}</div>
                        </div>`;
                }
                return `
                    <div class="role-card">
                        <div class="role-card-inner">
                            <div class="role-header">
                                <div class="role-icon">${role.icon}</div>
                                <div class="role-title title-english">${role.title}</div>
                                <div class="role-subtitle title-german">${role.subtitle}</div>
                            </div>
                            <div class="role-power">
                                ${role.powerName ? `<div class="power-name title-english">${role.powerName}</div>` : ''}
                                <div class="power-desc">${role.powerDesc}</div>
                                ${role.powerNote ? `<div class="power-note">${role.powerNote}</div>` : ''}
                            </div>
                        </div>
                    </div>`;
            }

            function renderBehaviorCard(behaviorId) {
                const behavior = BEHAVIOR_ROLES[behaviorId];
                if (!behavior) return '';
                if (behaviorId === 'no_behavior') {
                    return `
                        <div class="no-role-card">
                            <div class="no-role-icon">\u2205</div>
                            <div class="no-role-text title-english">${behavior.title}</div>
                            <div class="no-role-german title-german">${behavior.subtitle}</div>
                            <div class="no-role-subtext">${behavior.behavior}</div>
                        </div>`;
                }
                return `
                    <div class="role-card behavior-card">
                        <div class="role-card-inner">
                            <div class="role-header">
                                <div class="role-icon">${behavior.icon}</div>
                                <div class="role-title title-english">${behavior.title}</div>
                                <div class="role-subtitle title-german">${behavior.subtitle}</div>
                            </div>
                            <div class="role-power behavior-power">
                                <div class="power-desc behavior-desc">${behavior.behavior}</div>
                                <div class="behavior-reminder">Play this way throughout the game</div>
                            </div>
                        </div>
                    </div>`;
            }

            let html = '<div class="inspect-section-title">Power Roles</div>';
            html += '<div class="inspect-card-grid">';
            html += powerRoleIds.map(renderPowerCard).join('');
            html += '</div>';

            html += '<div class="inspect-section-title" style="margin-top: 28px;">Behavior Roles</div>';
            html += '<div class="inspect-card-grid">';
            html += behaviorRoleIds.map(renderBehaviorCard).join('');
            html += '</div>';

            container.innerHTML = html;
        }

        function inspectRole(roleId, type = 'power') {
            if (type === 'behavior') {
                displayBehaviorCard(roleId, 'inspect-role-card-container');
            } else {
                displayRoleCard(roleId, 'inspect-role-card-container');
            }
            showScreen('inspect-role-screen');
        }

        // ==================== GAME ACTIONS ====================
        async function confirmName() {
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) {
                showStatus('Please enter your name', true);
                return;
            }
            
            gameState.playerName = name;
            
            if (gameState.isHost) {
                await createGame();
            } else {
                await joinGame();
            }
        }

        async function createGame() {
            try {
                showStatus('Creating game...');
                
                // Check if API is configured
                // Call API to create game
                const result = await callAPI('createGame', {
                    hostName: gameState.playerName
                });
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to create game');
                }
                
                gameState.gameCode = result.gameCode;
                gameState.playerId = result.playerId;
                gameState.isHost = true;
                gameState.players = [{
                    id: gameState.playerId,
                    name: gameState.playerName,
                    isHost: true
                }];
                
                saveGameState();
                updateLobbyDisplay();
                showScreen('lobby-screen');
                generateQRCode();  // #4
                showStatus('Game created!');
                startPolling();
                
            } catch (error) {
                showStatus('Failed to create game: ' + error.message, true);
                console.error(error);
            }
        }

        function joinWithCode() {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            if (!code) {
                showStatus('Please enter a game code', true);
                return;
            }
            gameState.gameCode = code;
            gameState.isHost = false;
            showScreen('name-screen');
        }

        async function joinGame() {
            try {
                showStatus('Joining game...');
                
                // Call API to join game
                const result = await callAPI('joinGame', {
                    gameCode: gameState.gameCode,
                    playerName: gameState.playerName
                });
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to join game');
                }
                
                gameState.playerId = result.playerId;
                gameState.isHost = false;
                
                saveGameState();
                showScreen('waiting-screen');
                startPolling();
                
            } catch (error) {
                showStatus('Failed to join: ' + error.message, true);
                console.error(error);
            }
        }

        async function dealRoles() {
            if (!gameState.isHost) return;

            try {
                // Show countdown (#6)
                await showCountdown();

                showStatus('Dealing roles...');

                // First update role config on server (both power and behavior)
                await callAPI('updateRoleConfig', {
                    gameCode: gameState.gameCode,
                    playerId: gameState.playerId,
                    roleConfig: roleConfig,
                    behaviorConfig: behaviorConfig
                });

                // Then deal roles
                const result = await callAPI('dealRoles', {
                    gameCode: gameState.gameCode,
                    playerId: gameState.playerId
                });

                if (!result.success) {
                    throw new Error(result.error || 'Failed to deal roles');
                }

                gameState.rolesDealt = true;
                saveGameState();

                playChime(); // Sound effect (#1)
                showScreen('reveal-screen');
                showStatus('Roles dealt! Tap to reveal yours.');

            } catch (error) {
                showStatus('Failed to deal roles: ' + error.message, true);
                console.error(error);
            }
        }

        async function revealRole() {
            try {
                // Card flip animation (#7)
                const revealCard = document.querySelector('.reveal-card');
                revealCard.classList.add('flipping');
                haptic(200); // Haptic feedback (#2)

                // Fetch role from API
                showStatus('Revealing role...');
                const result = await callAPI('getMyRole', {
                    gameCode: gameState.gameCode,
                    playerId: gameState.playerId
                });

                if (!result.success) {
                    revealCard.classList.remove('flipping');
                    throw new Error(result.error || 'Failed to get role');
                }

                gameState.myRole = result.role;
                gameState.myBehavior = result.behavior || 'no_behavior';
                gameState.revealStep = 1;
                saveGameState();

                // Wait for flip midpoint then show role
                await new Promise(r => setTimeout(r, 400));

                playReveal(); // Sound effect (#1)
                haptic(300); // Haptic feedback (#2)

                // Hide the tabs - players get either power OR behavior, not both
                document.getElementById('role-nav-tabs').style.display = 'none';

                // Show the appropriate role
                if (gameState.myRole && gameState.myRole !== 'no_role') {
                    displayRoleCard(gameState.myRole);
                } else {
                    displayBehaviorCard(gameState.myBehavior);
                }
                showScreen('role-screen');
                revealCard.classList.remove('flipping');

            } catch (error) {
                showStatus('Failed to reveal role: ' + error.message, true);
                console.error(error);
            }
        }

        function showPowerRole() {
            gameState.revealStep = 1;
            displayRoleCard(gameState.myRole);
            updateRoleNavTabs();
        }

        function showBehaviorRole() {
            gameState.revealStep = 2;
            displayBehaviorCard(gameState.myBehavior);
            updateRoleNavTabs();
        }

        function updateRoleNavTabs() {
            const powerTab = document.getElementById('power-tab');
            const behaviorTab = document.getElementById('behavior-tab');
            
            if (gameState.revealStep === 1) {
                powerTab.classList.add('active');
                behaviorTab.classList.remove('active');
            } else {
                powerTab.classList.remove('active');
                behaviorTab.classList.add('active');
            }
        }

        function hideRole() {
            showScreen('reveal-screen');
        }

        function backToLobby() {
            showScreen('lobby-screen');
        }

        function leaveLobby() {
            if (confirm('Leave this game?')) {
                stopPolling();
                clearGameState();
                showScreen('start-screen');
            }
        }

        // ==================== UI UPDATES ====================
        function updateLobbyDisplay() {
            document.getElementById('lobby-code-display').textContent = gameState.gameCode;
            document.getElementById('player-count').textContent = gameState.players.length;
            
            const list = document.getElementById('player-list');
            list.innerHTML = gameState.players.map((p, i) => `
                <li class="player-item">
                    <span class="player-avatar" style="background: ${AVATAR_COLORS[i % AVATAR_COLORS.length]}">${AVATAR_ICONS[i % AVATAR_ICONS.length]}</span>
                    <span class="player-name">${p.name}</span>
                    ${p.isHost ? '<span class="player-host">HOST</span>' : ''}
                </li>
            `).join('');
            
            // Show role config only for host
            const roleConfigEl = document.getElementById('role-config');
            const behaviorConfigEl = document.getElementById('behavior-config');
            const viewRolesLink = document.getElementById('view-roles-link');
            
            // Always show view roles link
            viewRolesLink.style.display = 'block';
            
            if (gameState.isHost) {
                roleConfigEl.style.display = 'block';
                behaviorConfigEl.style.display = 'block';
                initRoleCheckboxes();
                initBehaviorCheckboxes();
            } else {
                roleConfigEl.style.display = 'none';
                behaviorConfigEl.style.display = 'none';
            }
            
            // Show deal button only for host with 2+ players
            const dealBtn = document.getElementById('deal-roles-btn');
            if (gameState.isHost && gameState.players.length >= 2) {
                dealBtn.style.display = 'block';
            } else {
                dealBtn.style.display = 'none';
            }
            
            // Update status
            const status = document.getElementById('lobby-status');
            if (gameState.players.length < 2) {
                status.textContent = 'Need at least 2 players to start...';
            } else {
                status.textContent = `${gameState.players.length} players ready`;
            }
            
            updateRoleConfigInfo();
            updateBehaviorConfigInfo();
        }

        // Role configuration functions
        // Power Roles
        const ALL_SPECIAL_ROLES = ['police_chief', 'assassin', 'journalist', 'industrialist', 'union_organizer', 'constitutional_judge'];
        let roleConfig = {
            mode: 'random',
            count: 6,
            roles: [...ALL_SPECIAL_ROLES]
        };

        // Behavior Roles
        const ALL_BEHAVIOR_ROLES = ['feminist', 'misogynist', 'aristocrat', 'proletarian', 'pacifist', 'militarist', 'monarchist', 'revolutionary', 'prussian', 'bavarian', 'devout', 'atheist', 'academic', 'worker', 'veteran', 'hothead'];
        let behaviorConfig = {
            mode: 'random',
            count: 19,
            behaviors: [...ALL_BEHAVIOR_ROLES]
        };

        function initRoleCheckboxes() {
            const container = document.getElementById('role-checkboxes');
            if (container.children.length > 0) return; // Already initialized
            
            container.innerHTML = ALL_SPECIAL_ROLES.map(roleId => {
                const role = ROLES[roleId];
                return `
                    <label class="role-checkbox">
                        <input type="checkbox" value="${roleId}" checked onchange="updateSelectedRoles()">
                        ${role.title}
                    </label>
                `;
            }).join('');
        }

        function initBehaviorCheckboxes() {
            const container = document.getElementById('behavior-checkboxes');
            if (container.children.length > 0) return; // Already initialized
            
            container.innerHTML = ALL_BEHAVIOR_ROLES.map(behaviorId => {
                const behavior = BEHAVIOR_ROLES[behaviorId];
                return `
                    <label class="role-checkbox">
                        <input type="checkbox" value="${behaviorId}" checked onchange="updateSelectedBehaviors()">
                        ${behavior.title}
                    </label>
                `;
            }).join('');
        }

        function updateRoleMode() {
            const mode = document.querySelector('input[name="roleMode"]:checked').value;
            roleConfig.mode = mode;
            
            const countSelect = document.getElementById('role-count-select');
            const checkboxes = document.getElementById('role-checkboxes');
            
            countSelect.disabled = (mode !== 'count');
            checkboxes.style.display = (mode === 'specific') ? 'flex' : 'none';
            
            updateRoleConfigInfo();
        }

        function updateBehaviorMode() {
            const mode = document.querySelector('input[name="behaviorMode"]:checked').value;
            behaviorConfig.mode = mode;
            
            const checkboxes = document.getElementById('behavior-checkboxes');
            checkboxes.style.display = (mode === 'specific') ? 'flex' : 'none';
            
            // If "none" is selected, set count to 0
            if (mode === 'none') {
                behaviorConfig.count = 0;
            } else {
                behaviorConfig.count = ALL_BEHAVIOR_ROLES.length;
            }
            
            updateBehaviorConfigInfo();
        }

        function updateRoleCount() {
            roleConfig.count = parseInt(document.getElementById('role-count-select').value);
            updateRoleConfigInfo();
        }

        function updateBehaviorCount() {
            behaviorConfig.count = parseInt(document.getElementById('behavior-count-select').value);
            updateBehaviorConfigInfo();
        }

        function updateSelectedRoles() {
            const checkboxes = document.querySelectorAll('#role-checkboxes input:checked');
            roleConfig.roles = Array.from(checkboxes).map(cb => cb.value);
            updateRoleConfigInfo();
        }

        function updateSelectedBehaviors() {
            const checkboxes = document.querySelectorAll('#behavior-checkboxes input:checked');
            behaviorConfig.behaviors = Array.from(checkboxes).map(cb => cb.value);
            updateBehaviorConfigInfo();
        }

        function getSelectedRoleCount() {
            if (roleConfig.mode === 'random') {
                return ALL_SPECIAL_ROLES.length;
            } else if (roleConfig.mode === 'count') {
                return roleConfig.count;
            } else {
                return roleConfig.roles.length;
            }
        }

        function getSelectedBehaviorCount() {
            if (behaviorConfig.mode === 'none') {
                return 0;
            } else if (behaviorConfig.mode === 'random') {
                return ALL_BEHAVIOR_ROLES.length;
            } else if (behaviorConfig.mode === 'specific') {
                return behaviorConfig.behaviors.length;
            } else {
                return behaviorConfig.count;
            }
        }

        function updateRoleConfigInfo() {
            const info = document.getElementById('role-config-info');
            const playerCount = gameState.players.length;
            let roleCount = getSelectedRoleCount();
            
            // Can't have more power roles than players
            if (playerCount > 0) {
                roleCount = Math.min(roleCount, playerCount);
            }
            
            if (playerCount === 0) {
                info.textContent = 'Waiting for players...';
            } else if (roleCount === 0) {
                info.textContent = 'No power roles will be assigned';
            } else if (roleCount >= playerCount) {
                info.textContent = `All ${playerCount} players get a power role`;
            } else {
                info.textContent = `${roleCount} player(s) get power roles`;
            }
            
            // Also update behavior info since it depends on power roles
            updateBehaviorConfigInfo();
        }

        function updateBehaviorConfigInfo() {
            const info = document.getElementById('behavior-config-info');
            const playerCount = gameState.players.length;
            const powerRoleCount = getSelectedRoleCount();
            const remainingPlayers = Math.max(0, playerCount - powerRoleCount);
            const behaviorCount = getSelectedBehaviorCount();
            
            if (behaviorConfig.mode === 'none') {
                if (remainingPlayers > 0) {
                    info.textContent = `${remainingPlayers} player(s) will get no special role`;
                } else {
                    info.textContent = 'No behavior roles assigned';
                }
            } else if (remainingPlayers === 0) {
                info.textContent = 'All players have power roles';
            } else {
                info.textContent = `${remainingPlayers} remaining player(s) get behavior roles`;
            }
        }

        function displayRoleCard(roleId, containerId = 'role-card-container') {
            const role = ROLES[roleId];
            if (!role) return;
            
            const container = document.getElementById(containerId);
            
            if (roleId === 'no_role') {
                container.innerHTML = `
                    <div class="no-role-card">
                        <div class="no-role-icon">∅</div>
                        <div class="no-role-text title-english">${role.title}</div>
                        <div class="no-role-german title-german">${role.subtitle}</div>
                        <div class="no-role-subtext">${role.powerDesc}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="role-card">
                    <div class="role-card-inner">
                        <div class="role-header">
                            <div class="role-icon">${role.icon}</div>
                            <div class="role-title title-english">${role.title}</div>
                            <div class="role-subtitle title-german">${role.subtitle}</div>
                        </div>
                        <div class="role-power">
                            ${role.powerName ? `<div class="power-name title-english">${role.powerName}</div>` : ''}
                            <div class="power-desc">${role.powerDesc}</div>
                            ${role.powerNote ? `<div class="power-note">${role.powerNote}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function displayBehaviorCard(behaviorId, containerId = 'role-card-container') {
            const behavior = BEHAVIOR_ROLES[behaviorId];
            if (!behavior) return;
            
            const container = document.getElementById(containerId);
            
            if (behaviorId === 'no_behavior') {
                container.innerHTML = `
                    <div class="no-role-card">
                        <div class="no-role-icon">∅</div>
                        <div class="no-role-text title-english">${behavior.title}</div>
                        <div class="no-role-german title-german">${behavior.subtitle}</div>
                        <div class="no-role-subtext">${behavior.behavior}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="role-card behavior-card">
                    <div class="role-card-inner">
                        <div class="role-header">
                            <div class="role-icon">${behavior.icon}</div>
                            <div class="role-title title-english">${behavior.title}</div>
                            <div class="role-subtitle title-german">${behavior.subtitle}</div>
                        </div>
                        <div class="role-power behavior-power">
                            <div class="power-desc behavior-desc">${behavior.behavior}</div>
                            <div class="behavior-reminder">Play this way throughout the game</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function copyGameCode() {
            const btn = document.querySelector('.lobby-actions .btn-secondary');
            navigator.clipboard.writeText(gameState.gameCode).then(() => {
                playClick(); // Sound effect (#1)
                haptic(50); // Haptic (#2)
                // Visual feedback on button (#3)
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = 'var(--gold)';
                btn.style.color = 'var(--brown)';
                setTimeout(() => {
                    btn.textContent = original;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
                showStatus('Code copied to clipboard!');
            }).catch(() => {
                showStatus('Failed to copy', true);
            });
        }

        // ==================== UTILITIES ====================
        function generateGameCode() {
            // 4 letters + 2 numbers (e.g., ABCD12)
            const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            const numbers = '0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            for (let i = 0; i < 2; i++) {
                code += numbers.charAt(Math.floor(Math.random() * numbers.length));
            }
            return code;
        }

        function generatePlayerId() {
            return 'p_' + Math.random().toString(36).substr(2, 9);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showStatus(message, isError = false) {
            const el = document.getElementById('status-message');
            const icon = isError ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>';
            el.innerHTML = icon + ' ' + message;
            el.className = 'status-message show' + (isError ? ' error' : '');
            clearTimeout(el._timer);
            el._timer = setTimeout(() => el.classList.remove('show'), 3000);
        }

        function saveGameState() {
            localStorage.setItem('weimarCrisis', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('weimarCrisis');
            if (saved) {
                gameState = JSON.parse(saved);
                return true;
            }
            return false;
        }

        function clearGameState() {
            gameState = {
                gameCode: null,
                playerId: null,
                playerName: null,
                isHost: false,
                players: [],
                myRole: null,
                rolesDealt: false
            };
            localStorage.removeItem('weimarCrisis');
        }

        // Track known players for join toast (#8)
        let knownPlayerIds = new Set();

        // Polling for player/game updates (with join toasts #8)
        function startPolling() {
            stopPolling(); // Clear any existing timer
            // Initialize known players
            knownPlayerIds = new Set(gameState.players.map(p => p.id));

            pollTimer = setInterval(async () => {
                try {
                    // Get latest player list
                    const playersResult = await callAPI('getPlayers', {
                        gameCode: gameState.gameCode
                    });

                    if (playersResult.success) {
                        // Detect new players for toast (#8)
                        playersResult.players.forEach(p => {
                            if (!knownPlayerIds.has(p.id) && p.id !== gameState.playerId) {
                                showStatus(`${p.name} joined!`);
                                playClick();
                                haptic(100);
                            }
                        });
                        knownPlayerIds = new Set(playersResult.players.map(p => p.id));

                        gameState.players = playersResult.players;

                        // Check if roles were dealt
                        if (playersResult.rolesDealt && !gameState.rolesDealt) {
                            gameState.rolesDealt = true;
                            saveGameState();
                            stopPolling();
                            playChime();
                            haptic(300);
                            showScreen('reveal-screen');
                            showStatus('Roles have been dealt! Tap to reveal yours.');
                            return;
                        }

                        // Update lobby display if we're on that screen
                        if (document.getElementById('lobby-screen').classList.contains('active')) {
                            updateLobbyDisplay();
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, POLL_INTERVAL);
        }

        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }

        // ==================== PLAYER AVATARS (#5) ====================
        const AVATAR_COLORS = [
            '#C23B22', '#4A6FA5', '#C9A227', '#2C8C4A', '#8B5CF6',
            '#D97706', '#0891B2', '#DC2626', '#7C3AED', '#059669',
            '#EA580C', '#2563EB', '#CA8A04', '#16A34A', '#9333EA'
        ];
        const AVATAR_ICONS = [
            '<i class="fas fa-shield-halved"></i>',
            '<i class="fas fa-bolt"></i>',
            '<i class="fas fa-fire"></i>',
            '<i class="fas fa-crown"></i>',
            '<i class="fas fa-star"></i>',
            '<i class="fas fa-chess-rook"></i>',
            '<i class="fas fa-feather-pointed"></i>',
            '<i class="fas fa-skull"></i>',
            '<i class="fas fa-dove"></i>',
            '<i class="fas fa-gem"></i>',
            '<i class="fas fa-landmark"></i>',
            '<i class="fas fa-sun"></i>',
            '<i class="fas fa-moon"></i>',
            '<i class="fas fa-medal"></i>',
            '<i class="fas fa-cross"></i>'
        ];

        // ==================== SOUND EFFECTS (#1) ====================
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function getAudioCtx() {
            if (!audioCtx) audioCtx = new AudioCtx();
            return audioCtx;
        }

        function playClick() {
            try {
                const ctx = getAudioCtx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                gain.gain.value = 0.1;
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.1);
            } catch(e) {}
        }

        function playChime() {
            try {
                const ctx = getAudioCtx();
                [523, 659, 784].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.value = 0.15;
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5 + i * 0.15);
                    osc.start(ctx.currentTime + i * 0.15);
                    osc.stop(ctx.currentTime + 0.5 + i * 0.15);
                });
            } catch(e) {}
        }

        function playReveal() {
            try {
                const ctx = getAudioCtx();
                [392, 494, 587, 784].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'triangle';
                    gain.gain.value = 0.12;
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8 + i * 0.1);
                    osc.start(ctx.currentTime + i * 0.1);
                    osc.stop(ctx.currentTime + 0.8 + i * 0.1);
                });
            } catch(e) {}
        }

        // ==================== HAPTIC FEEDBACK (#2) ====================
        function haptic(ms = 200) {
            try { navigator.vibrate && navigator.vibrate(ms); } catch(e) {}
        }

        // ==================== COUNTDOWN ANIMATION (#6) ====================
        function showCountdown() {
            return new Promise(resolve => {
                const overlay = document.getElementById('countdown-overlay');
                const num = document.getElementById('countdown-number');
                overlay.classList.add('active');
                let count = 3;
                num.textContent = count;
                num.classList.remove('pop');
                void num.offsetHeight;
                num.classList.add('pop');
                playClick();

                const interval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        num.textContent = count;
                        num.classList.remove('pop');
                        void num.offsetHeight;
                        num.classList.add('pop');
                        playClick();
                        haptic(50);
                    } else {
                        clearInterval(interval);
                        overlay.classList.remove('active');
                        resolve();
                    }
                }, 1000);
            });
        }

        // ==================== QR CODE (#4) ====================
        let qrInstance = null;
        function generateQRCode() {
            const container = document.getElementById('qr-code');
            const section = document.getElementById('qr-section');
            if (!gameState.gameCode || typeof QRCode === 'undefined') {
                section.style.display = 'none';
                return;
            }
            container.innerHTML = '';
            const joinUrl = window.location.href.split('?')[0] + '?code=' + gameState.gameCode;
            try {
                qrInstance = new QRCode(container, {
                    text: joinUrl,
                    width: 120,
                    height: 120,
                    colorDark: '#2C2416',
                    colorLight: '#D4C5A9'
                });
                section.style.display = 'block';
            } catch(e) {
                section.style.display = 'none';
            }
        }

        // ==================== OFFLINE DETECTION (#10) ====================
        function setupOfflineDetection() {
            const banner = document.getElementById('offline-banner');
            window.addEventListener('online', () => {
                banner.classList.remove('visible');
                showStatus('Back online');
            });
            window.addEventListener('offline', () => {
                banner.classList.add('visible');
            });
            if (!navigator.onLine) {
                banner.classList.add('visible');
            }
        }

        // ==================== SWIPE NAVIGATION (#11) ====================
        function setupSwipeNavigation() {
            const roleScreen = document.getElementById('role-screen');
            let touchStartX = 0;
            let touchStartY = 0;

            roleScreen.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            roleScreen.addEventListener('touchend', (e) => {
                const dx = touchStartX - e.changedTouches[0].screenX;
                const dy = touchStartY - e.changedTouches[0].screenY;
                // Only trigger if horizontal swipe is dominant and > 60px
                if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy) * 1.5) {
                    // Only swipe when tabs are visible (both power + behavior)
                    if (document.getElementById('role-nav-tabs').style.display !== 'none') {
                        if (dx > 0) {
                            showBehaviorRole();
                        } else {
                            showPowerRole();
                        }
                        haptic(30);
                    }
                }
            }, { passive: true });
        }

        // ==================== PULL TO REFRESH (#12) ====================
        function setupPullToRefresh() {
            const lobby = document.getElementById('lobby-screen');
            const indicator = document.getElementById('pull-indicator');
            let startY = 0;
            let pulling = false;

            lobby.addEventListener('touchstart', (e) => {
                if (lobby.scrollTop <= 0) {
                    startY = e.touches[0].pageY;
                    pulling = true;
                }
            }, { passive: true });

            lobby.addEventListener('touchmove', (e) => {
                if (!pulling) return;
                const diff = e.touches[0].pageY - startY;
                if (diff > 50 && diff < 150) {
                    indicator.classList.add('visible');
                    indicator.innerHTML = '<i class="fas fa-arrow-down"></i> Release to refresh';
                } else if (diff <= 10) {
                    indicator.classList.remove('visible');
                }
            }, { passive: true });

            lobby.addEventListener('touchend', async () => {
                if (!pulling) return;
                pulling = false;
                if (indicator.classList.contains('visible')) {
                    indicator.innerHTML = '<i class="fas fa-spinner"></i> Refreshing...';
                    indicator.classList.add('refreshing');
                    try {
                        const result = await callAPI('getPlayers', { gameCode: gameState.gameCode });
                        if (result.success) {
                            gameState.players = result.players;
                            updateLobbyDisplay();
                            showStatus('Player list refreshed');
                        }
                    } catch(e) {
                        showStatus('Refresh failed', true);
                    }
                    indicator.classList.remove('visible', 'refreshing');
                }
            }, { passive: true });
        }

        // ==================== BUTTON CLICK SOUNDS (#1) ====================
        function setupButtonSounds() {
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    playClick();
                    haptic(30);
                });
            });
        }

        // ==================== INIT ====================
        function init() {
            // Setup new features
            setupOfflineDetection();  // #10
            setupSwipeNavigation();   // #11
            setupPullToRefresh();     // #12
            setupButtonSounds();      // #1

            // Check for game code in URL params (#4 - QR join support)
            const urlParams = new URLSearchParams(window.location.search);
            const urlCode = urlParams.get('code');
            if (urlCode) {
                document.getElementById('join-code-input').value = urlCode.toUpperCase();
                // Clean URL without reloading
                window.history.replaceState({}, '', window.location.pathname);
            }

            // Check for saved game state
            if (loadGameState() && gameState.gameCode) {
                if (gameState.rolesDealt && gameState.myRole) {
                    showScreen('reveal-screen');
                } else if (gameState.isHost) {
                    updateLobbyDisplay();
                    showScreen('lobby-screen');
                    generateQRCode();  // #4
                    startPolling();
                } else {
                    showScreen('waiting-screen');
                    startPolling();
                }
            }

            // Handle Enter key on inputs
            document.getElementById('join-code-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinWithCode();
            });
            document.getElementById('player-name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') confirmName();
            });
        }

        init();
    </script>
</body>
</html>
